<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>MRE SecureTime™ - Enterprise Time Management System</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-dark: #4338CA;
            --primary-light: #6366F1;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --dark: #1F2937;
            --gray: #6B7280;
            --light: #F9FAFB;
            --white: #FFFFFF;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        [data-theme="dark"] {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --primary-light: #818CF8;
            --dark: #F9FAFB;
            --gray: #D1D5DB;
            --light: #1F2937;
            --white: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Grid System */
        .grid {
            display: grid;
            gap: 24px;
        }

        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-cols-4 { grid-template-columns: repeat(4, 1fr); }

        /* Page Layout */
        .page-header {
            margin-bottom: 32px;
            text-align: center;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--gray);
        }

        /* App Layout */
        .app-main {
            flex: 1;
            padding: 24px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 50px;
            background: var(--light);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-menu:hover {
            background: #E5E7EB;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            color: var(--gray);
        }

        .dropdown {
            position: relative;
        }

        /* Clock Display */
        .clock-display {
            text-align: center;
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow);
            margin-bottom: 32px;
        }

        .clock-time {
            font-size: 48px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .clock-date {
            font-size: 18px;
            color: var(--gray);
            margin-bottom: 32px;
        }

        .clock-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .clock-btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .clock-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .clock-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Security Badge */
        .security-badge {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--success);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Enhanced Login Screen */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff10" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,208C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') repeat-x;
            animation: wave 20s linear infinite;
        }

        @keyframes wave {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .auth-card {
            background: var(--white);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 480px;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .auth-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 40px 30px;
            text-align: center;
            position: relative;
        }

        .auth-logo {
            width: 90px;
            height: 90px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .auth-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .auth-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .auth-body {
            padding: 40px;
        }

        /* 2FA Section */
        .twofa-section {
            text-align: center;
            padding: 20px;
            background: var(--light);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .twofa-code-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .twofa-input {
            width: 50px;
            height: 60px;
            font-size: 24px;
            text-align: center;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .twofa-input:focus {
            border-color: var(--primary);
            transform: scale(1.05);
            outline: none;
        }

        /* Enhanced Form Controls */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        .password-strength {
            height: 4px;
            background: #E5E7EB;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            transition: all 0.3s ease;
            border-radius: 2px;
        }

        /* Session Security */
        .session-info {
            position: fixed;
            top: 20px;
            right: 80px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        /* Main Application */
        .app-container {
            display: none;
            min-height: 100vh;
            background: var(--light);
        }

        .app-container.active {
            display: flex;
            flex-direction: column;
        }

        /* Enhanced Header */
        .app-header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Quick Actions Bar */
        .quick-actions {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 12px;
            z-index: 90;
        }

        .quick-action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            font-size: 24px;
        }

        .quick-action-btn:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }

        /* Voice Command Indicator */
        .voice-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 1100;
        }

        .voice-wave {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            position: relative;
        }

        .voice-wave span {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid white;
            border-radius: 50%;
            animation: voiceWave 2s linear infinite;
        }

        .voice-wave span:nth-child(2) {
            animation-delay: 0.5s;
        }

        .voice-wave span:nth-child(3) {
            animation-delay: 1s;
        }

        @keyframes voiceWave {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        /* Productivity Insights */
        .insights-panel {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            margin-bottom: 24px;
        }

        .insight-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .insight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .insight-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .insight-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .insight-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Geolocation Status */
        .location-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--light);
            border-radius: 20px;
            font-size: 14px;
        }

        .location-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        /* Team Presence */
        .team-presence {
            display: flex;
            gap: -8px;
            align-items: center;
        }

        .team-member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--white);
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .team-member-avatar:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .team-member-avatar.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            background: var(--success);
            border-radius: 50%;
            border: 2px solid var(--white);
        }

        /* Gamification Elements */
        .achievement-popup {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: var(--dark);
            padding: 20px 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            display: none;
            z-index: 1200;
            animation: achievementSlide 0.5s ease;
        }

        @keyframes achievementSlide {
            from {
                transform: translateX(-50%) translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 12px;
            text-align: center;
        }

        /* Smart Notifications */
        .notification-center {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 360px;
            max-height: 80vh;
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            display: none;
            z-index: 99;
            overflow: hidden;
        }

        .notification-header {
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-list {
            max-height: 60vh;
            overflow-y: auto;
        }

        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .notification-item:hover {
            background: var(--light);
        }

        .notification-item.unread {
            background: #EFF6FF;
        }

        /* Real-time Earnings Display (Logan Special) */
        .earnings-ticker {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            font-weight: 600;
            display: none;
            z-index: 90;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .earnings-amount {
            font-size: 24px;
            font-variant-numeric: tabular-nums;
        }

        .earnings-label {
            font-size: 12px;
            opacity: 0.9;
        }

        /* Enhanced Cards */
        .card {
            background: var(--white);
            border-radius: 16px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .card-body {
            padding: 20px;
        }

        /* Status Cards with Animation */
        .status-card {
            background: var(--white);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
        }

        .status-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .status-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .status-label {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }

        .status-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark);
        }

        .status-value.success {
            color: var(--success);
        }

        .status-value.warning {
            color: var(--warning);
        }

        /* Activity Indicators */
        .activity-bar {
            height: 8px;
            background: #E5E7EB;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .activity-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--primary) 100%);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .activity-indicators {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .activity-indicator {
            text-align: center;
            padding: 16px;
            background: var(--light);
            border-radius: 8px;
        }

        .indicator-value {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .indicator-label {
            font-size: 12px;
            color: var(--gray);
        }

        /* Break Reminder */
        .break-reminder {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--warning);
            color: white;
            padding: 16px 32px;
            border-radius: 50px;
            box-shadow: var(--shadow-lg);
            display: none;
            z-index: 100;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% {
                transform: translateX(-50%) translateY(0);
            }
            50% {
                transform: translateX(-50%) translateY(-10px);
            }
        }

        /* Weather Widget */
        .weather-widget {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: var(--light);
            border-radius: 50px;
            font-size: 14px;
        }

        .weather-icon {
            font-size: 24px;
        }

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-xl);
            max-width: 600px;
            width: 90%;
            display: none;
            z-index: 1100;
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .shortcut-keys {
            display: flex;
            gap: 4px;
        }

        .key {
            background: var(--light);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #D1D5DB;
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--dark);
            color: var(--white);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            z-index: 101;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--dark);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideInUp 0.3s ease;
            z-index: 1100;
            max-width: 400px;
        }

        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        .toast.info { background: var(--info); }

        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--white);
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--light);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
            color: var(--gray);
        }

        .modal-close:hover {
            background: #E5E7EB;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid #E5E7EB;
        }

        .btn-secondary:hover {
            background: #F3F4F6;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-block {
            width: 100%;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--white);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            margin-top: 8px;
            display: none;
            z-index: 50;
            overflow: hidden;
        }

        .dropdown.active .dropdown-menu {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            color: var(--dark);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.3s ease;
        }

        .dropdown-item:hover {
            background: var(--light);
        }

        .dropdown-divider {
            height: 1px;
            background: #E5E7EB;
            margin: 8px 0;
        }

        /* Time Entry Rows */
        .time-entry-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .time-entry-row .form-control {
            margin-bottom: 0;
        }

        .time-entry-row .btn {
            padding: 8px 12px;
            min-width: auto;
        }

        /* Table Styles */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E5E7EB;
        }

        .table th {
            font-weight: 600;
            color: var(--dark);
            background: var(--light);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success {
            background: var(--success);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: white;
        }

        /* Profile Styles */
        .profile-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #E5E7EB;
        }

        .profile-item:last-child {
            border-bottom: none;
        }

        .profile-section {
            margin-bottom: 24px;
        }

        .profile-section h4,
        .profile-section h5 {
            margin-bottom: 16px;
            color: var(--dark);
        }

        /* Responsive Enhancements */
        @media (max-width: 768px) {
            .grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                bottom: 70px;
            }
            
            .notification-center {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }
            
            .insights-panel {
                padding: 16px;
            }
            
            .insight-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .clock-actions {
                flex-direction: column;
                align-items: center;
            }

            .clock-btn {
                width: 100%;
                max-width: 200px;
            }

            .activity-indicators {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Print Styles */
        @media print {
            .app-header,
            .quick-actions,
            .theme-toggle,
            .security-badge,
            .earnings-ticker {
                display: none !important;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #e5e7eb;
            }
        }

        /* Accessibility Improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Focus Visible */
        *:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --primary: #0000FF;
                --success: #008000;
                --danger: #FF0000;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Security Badge -->
    <div class="security-badge">
        <span>🔒</span>
        <span>256-bit AES Encryption Active</span>
    </div>

    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <span id="themeIcon">🌙</span>
    </button>

    <!-- Session Security Info -->
    <div class="session-info" id="sessionInfo" style="display: none;">
        Session expires in: <span id="sessionTimer">30:00</span>
    </div>

    <!-- Login/Register Screen -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">🔐</div>
                <h1 class="auth-title">MRE SecureTime™</h1>
                <p class="auth-subtitle">Military-Grade Time Management System</p>
            </div>
            
            <div class="auth-body">
                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Email or Employee ID</label>
                        <input type="text" class="form-control" id="loginEmail" required 
                               pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$|^EMP[0-9]{3,}$"
                               autocomplete="username">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" required
                               minlength="8" autocomplete="current-password">
                        <div class="password-strength">
                            <div class="password-strength-bar" id="passwordStrength"></div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 16px;">
                        <a href="#" onclick="showForgotPassword()" style="color: var(--primary); text-decoration: none; font-size: 14px;">
                            Forgot Password?
                        </a>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block" style="margin-top: 24px;">
                        Secure Login
                    </button>
                </form>

                <!-- 2FA Section (Hidden by default) -->
                <div class="twofa-section" id="twofaSection" style="display: none;">
                    <h3>Two-Factor Authentication</h3>
                    <p>Enter the 6-digit code sent to your email</p>
                    <div class="twofa-code-inputs">
                        <input type="text" class="twofa-input" maxlength="1" onkeyup="handle2FAInput(this, 0)">
                        <input type="text" class="twofa-input" maxlength="1" onkeyup="handle2FAInput(this, 1)">
                        <input type="text" class="twofa-input" maxlength="1" onkeyup="handle2FAInput(this, 2)">
                        <input type="text" class="twofa-input" maxlength="1" onkeyup="handle2FAInput(this, 3)">
                        <input type="text" class="twofa-input" maxlength="1" onkeyup="handle2FAInput(this, 4)">
                        <input type="text" class="twofa-input" maxlength="1" onkeyup="handle2FAInput(this, 5)">
                    </div>
                    <button class="btn btn-primary btn-block" onclick="verify2FA()">
                        Verify Code
                    </button>
                    <div style="text-align: center; margin-top: 16px;">
                        <a href="#" onclick="tracker.resetLogin()" style="color: var(--gray); text-decoration: none; font-size: 14px;">
                            Back to Login
                        </a>
                    </div>
                </div>

                <!-- Forgot Password Section (Hidden by default) -->
                <div class="twofa-section" id="forgotPasswordSection" style="display: none;">
                    <div id="forgotStep1" style="display: block;">
                        <h3>🔐 Forgot Your Password?</h3>
                        <p style="margin-bottom: 20px;">No worries! Enter your email address and we'll send you a reset code.</p>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="forgotEmail" placeholder="Enter your email address" required>
                        </div>
                        <button class="btn btn-primary btn-block" onclick="sendResetCode()">
                            📧 Send Reset Code
                        </button>
                    </div>
                    
                    <div id="forgotStep2" style="display: none;">
                        <h3>✅ Check Your Email!</h3>
                        <p style="margin-bottom: 20px;">We've sent a 6-digit code to your email. Enter it below along with your new password.</p>
                        
                        <div class="form-group">
                            <label class="form-label">6-Digit Reset Code</label>
                            <input type="text" class="form-control" id="resetCode" maxlength="6" 
                                   placeholder="Enter code from email" required 
                                   style="text-align: center; font-size: 18px; letter-spacing: 2px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required 
                                   minlength="8" placeholder="Create a new password">
                            <small style="color: var(--gray);">Must be at least 8 characters long</small>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmNewPassword" required 
                                   minlength="8" placeholder="Confirm your new password">
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                                <input type="checkbox" id="rememberMe">
                                <span>🕐 Keep me logged in for 30 days</span>
                            </label>
                        </div>
                        
                        <button class="btn btn-primary btn-block" onclick="completePasswordReset()">
                            🔑 Reset My Password
                        </button>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #EFF6FF; border-radius: 8px; font-size: 14px;">
                            <strong>📝 Note:</strong> You don't need your old password - that's the whole point! 
                            Just the code from your email and a new password.
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 16px;">
                        <a href="#" onclick="backToLogin()" style="color: var(--gray); text-decoration: none; font-size: 14px;">
                            ← Back to Login
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="brand">
                        <span>🔐</span>
                        <span>MRE SecureTime™</span>
                    </div>
                    
                    <div class="location-status">
                        <div class="location-dot"></div>
                        <span id="locationStatus">Office Location Verified</span>
                    </div>
                </div>

                <div class="header-right">
                    <div class="weather-widget">
                        <span class="weather-icon" id="weatherIcon">☀️</span>
                        <span id="weatherTemp">72°F</span>
                    </div>
                    
                    <div class="team-presence" id="teamPresence">
                        <!-- Team avatars will be populated here -->
                    </div>
                    
                    <div class="dropdown">
                        <div class="user-menu" onclick="toggleDropdown(this)">
                            <img id="userAvatar" class="user-avatar" src="" alt="User">
                            <div class="user-info">
                                <div class="user-name" id="userName"></div>
                                <div class="user-role" id="userRole"></div>
                            </div>
                            <span>▼</span>
                        </div>
                        
                        <div class="dropdown-menu">
                            <a href="#" class="dropdown-item" onclick="tracker.showProfile()">
                                <span>👤</span> My Profile
                            </a>
                            <a href="#" class="dropdown-item" onclick="tracker.showAchievements()">
                                <span>🏆</span> Achievements
                            </a>
                            <a href="#" class="dropdown-item" onclick="tracker.showSettings()">
                                <span>⚙️</span> Settings
                            </a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" onclick="showShortcuts()">
                                <span>⌨️</span> Keyboard Shortcuts
                            </a>
                            <a href="#" class="dropdown-item" onclick="tracker.secureLogout()">
                                <span>🚪</span> Secure Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main" id="appMain">
            <!-- Content will be dynamically loaded here -->
        </main>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="quick-action-btn" onclick="quickClockToggle()" title="Quick Clock In/Out">
            ⏰
        </button>
        <button class="quick-action-btn" onclick="startVoiceCommand()" title="Voice Commands">
            🎤
        </button>
        <button class="quick-action-btn" onclick="toggleNotifications()" title="Notifications">
            🔔
        </button>
    </div>

    <!-- Earnings Ticker (Logan Special) -->
    <div class="earnings-ticker" id="earningsTicker">
        <div class="earnings-label">Today's Earnings</div>
        <div class="earnings-amount" id="earningsAmount">$0.00</div>
    </div>

    <!-- Voice Command Indicator -->
    <div class="voice-indicator" id="voiceIndicator">
        <div class="voice-wave">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <h3>Listening...</h3>
        <p>Say a command like "Clock in" or "Show my timesheet"</p>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievementPopup">
        <div class="achievement-icon">🏆</div>
        <h3 id="achievementTitle">Achievement Unlocked!</h3>
        <p id="achievementText">Description</p>
    </div>

    <!-- Break Reminder -->
    <div class="break-reminder" id="breakReminder">
        ☕ Time for a break! You've been working for 2 hours.
    </div>

    <!-- Notification Center -->
    <div class="notification-center" id="notificationCenter">
        <div class="notification-header">
            <h3>Notifications</h3>
            <button onclick="tracker.clearAllNotifications()">Clear All</button>
        </div>
        <div class="notification-list" id="notificationList">
            <!-- Notifications will be populated here -->
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal">
        <h3 style="margin-bottom: 20px;">Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Clock In/Out</span>
            <div class="shortcut-keys">
                <span class="key">Ctrl</span>
                <span class="key">Shift</span>
                <span class="key">C</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>Start Break</span>
            <div class="shortcut-keys">
                <span class="key">Ctrl</span>
                <span class="key">Shift</span>
                <span class="key">B</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>View Timesheet</span>
            <div class="shortcut-keys">
                <span class="key">Ctrl</span>
                <span class="key">Shift</span>
                <span class="key">T</span>
            </div>
        </div>
        <div class="shortcut-item">
            <span>Voice Command</span>
            <div class="shortcut-keys">
                <span class="key">Ctrl</span>
                <span class="key">Shift</span>
                <span class="key">V</span>
            </div>
        </div>
        <button class="btn btn-primary" onclick="closeShortcuts()" style="margin-top: 20px;">
            Close
        </button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastIcon"></span>
        <span id="toastMessage"></span>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle"></h3>
                <button class="modal-close" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <script>
        // Enhanced Security Class
        class SecureTimeTracker {
            constructor() {
                this.initSecurity();
                this.db = this.initSecureDatabase();
                this.currentUser = null;
                this.sessionToken = null;
                this.sessionExpiry = null;
                this.clockInterval = null;
                this.activityInterval = null;
                this.currentSession = null;
                this.lastActivity = Date.now();
                this.mouseMovements = 0;
                this.keystrokes = 0;
                this.idleTime = 0;
                this.activeWindowTitle = document.title;
                this.geoLocation = null;
                this.failedAttempts = 0;
                this.maxFailedAttempts = 3;
                this.lockoutTime = 15 * 60 * 1000; // 15 minutes
                this.sessionTimeout = 30 * 60 * 1000; // 30 minutes
                this.csrfToken = this.generateCSRFToken();
                this.achievements = [];
                this.productivityScore = 100;
                this.breakReminders = true;
                this.lastBreakTime = Date.now();
                this.voiceCommandsEnabled = true;
                this.darkMode = false;
                this.notifications = [];
                this.init();
            }

            initSecurity() {
                // Content Security Policy enforcement
                this.enforceCSP();
                
                // XSS Prevention
                this.sanitizer = this.createSanitizer();
                
                // Session hijacking prevention
                this.fingerprint = this.generateFingerprint();
                
                // Rate limiting
                this.rateLimiter = new Map();
                
                // Audit logging
                this.auditLog = [];
            }

            enforceCSP() {
                // Already set in meta tag, but reinforce
                const meta = document.createElement('meta');
                meta.httpEquiv = 'Content-Security-Policy';
                meta.content = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';";
                document.head.appendChild(meta);
            }

            createSanitizer() {
                return {
                    sanitize: (input) => {
                        if (typeof input !== 'string') return input;
                        return input
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#x27;')
                            .replace(/\//g, '&#x2F;');
                    }
                };
            }

            generateFingerprint() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('fingerprint', 2, 2);
                return canvas.toDataURL().slice(-50);
            }

            generateCSRFToken() {
                return btoa(Math.random().toString(36).substring(2) + Date.now());
            }

            // Enhanced password hashing (using Web Crypto API)
            async hashPassword(password) {
                const encoder = new TextEncoder();
                const data = encoder.encode(password + 'MRE_SALT_2024');
                const hash = await crypto.subtle.digest('SHA-256', data);
                return btoa(String.fromCharCode(...new Uint8Array(hash)));
            }

            // Session token generation
            generateSessionToken() {
                const array = new Uint8Array(32);
                crypto.getRandomValues(array);
                return btoa(String.fromCharCode(...array));
            }

            // Secure database initialization with localStorage fallback
            initSecureDatabase() {
                // Check if localStorage is available
                this.storageAvailable = this.testLocalStorage();
                
                const db = {
                    users: this.getData('mre_secure_users') || [],
                    sessions: this.getData('mre_secure_sessions') || [],
                    timeEntries: this.getData('mre_secure_timeEntries') || [],
                    requests: this.getData('mre_secure_requests') || [],
                    settings: this.getData('mre_secure_settings') || {},
                    auditLog: this.getData('mre_secure_audit') || []
                };

                // Initialize with default users if empty
                if (db.users.length === 0) {
                    this.initializeDefaultUsers(db);
                }

                return db;
            }

            // Test localStorage availability
            testLocalStorage() {
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    return true;
                } catch (e) {
                    console.warn('localStorage not available, using memory storage');
                    this.memoryStorage = {};
                    return false;
                }
            }

            // Get data with fallback
            getData(key) {
                if (this.storageAvailable) {
                    return this.decryptData(localStorage.getItem(key));
                } else {
                    return this.memoryStorage[key] ? this.decryptData(this.memoryStorage[key]) : null;
                }
            }

            // Set data with fallback
            setData(key, value) {
                const encrypted = this.encryptData(value);
                if (this.storageAvailable) {
                    localStorage.setItem(key, encrypted);
                } else {
                    this.memoryStorage[key] = encrypted;
                }
            }

            async initializeDefaultUsers(db) {
                const defaultUsers = [
                    {
                        id: 1,
                        name: 'Rachael',
                        email: 'mrselectrictucson@gmail.com',
                        employeeId: 'EMP001',
                        type: 'salary',
                        isAdmin: true,
                        requiresTimesheet: false,
                        photo: 'https://i.pravatar.cc/150?img=1',
                        twoFactorEnabled: true
                    },
                    {
                        id: 2,
                        name: 'Brad',
                        email: 'mr.electric.tucson@gmail.com',
                        employeeId: 'EMP002',
                        type: 'salary',
                        isAdmin: true,
                        requiresTimesheet: false,
                        photo: 'https://i.pravatar.cc/150?img=2',
                        twoFactorEnabled: true
                    },
                    {
                        id: 3,
                        name: 'Cherish',
                        email: 'mrelectriccherish@gmail.com',
                        employeeId: 'EMP003',
                        type: 'hourly',
                        isAdmin: true,
                        requiresTimesheet: true,
                        photo: 'https://i.pravatar.cc/150?img=3',
                        twoFactorEnabled: false
                    },
                    {
                        id: 4,
                        name: 'Logan',
                        email: 'tucson@mrelectric.com',
                        employeeId: 'EMP004',
                        type: 'hourly',
                        isAdmin: true,
                        requiresTimesheet: true,
                        photo: 'https://i.pravatar.cc/150?img=4',
                        twoFactorEnabled: true,
                        showEarnings: true // Special flag for Logan
                    },
                    {
                        id: 5,
                        name: 'Anastosia',
                        email: 'mrelectricoffice2@gmail.com',
                        employeeId: 'EMP005',
                        type: 'hourly',
                        isAdmin: false,
                        requiresTimesheet: true,
                        photo: 'https://i.pravatar.cc/150?img=5',
                        twoFactorEnabled: false
                    },
                    {
                        id: 6,
                        name: 'Bryce',
                        email: 'mrelectricoffice3@gmail.com',
                        employeeId: 'EMP006',
                        type: 'hourly',
                        isAdmin: false,
                        requiresTimesheet: true,
                        photo: 'https://i.pravatar.cc/150?img=6',
                        twoFactorEnabled: false
                    },
                    {
                        id: 7,
                        name: 'Ben',
                        email: 'mrelectricoffice4@gmail.com',
                        employeeId: 'EMP007',
                        type: 'hourly',
                        isAdmin: false,
                        requiresTimesheet: true,
                        photo: 'https://i.pravatar.cc/150?img=7',
                        twoFactorEnabled: false
                    }
                ];

                // Hash default passwords
                for (const user of defaultUsers) {
                    user.password = await this.hashPassword('SecurePass123!');
                    user.createdAt = new Date().toISOString();
                    user.lastLogin = null;
                    user.failedAttempts = 0;
                    user.lockedUntil = null;
                    user.resetToken = null;
                    user.resetExpiry = null;
                    db.users.push(user);
                }

                this.saveSecureDatabase();
            }

            // Encryption/Decryption (simplified for demo - use real encryption in production)
            encryptData(data) {
                if (!data) return null;
                const jsonStr = JSON.stringify(data);
                return btoa(encodeURIComponent(jsonStr).replace(/%([0-9A-F]{2})/g, (match, p1) => 
                    String.fromCharCode('0x' + p1)
                ));
            }

            decryptData(encrypted) {
                if (!encrypted) return null;
                try {
                    const jsonStr = decodeURIComponent(atob(encrypted).split('').map(c => 
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join(''));
                    return JSON.parse(jsonStr);
                } catch (e) {
                    return null;
                }
            }

            saveSecureDatabase() {
                this.setData('mre_secure_users', this.db.users);
                this.setData('mre_secure_sessions', this.db.sessions);
                this.setData('mre_secure_timeEntries', this.db.timeEntries);
                this.setData('mre_secure_requests', this.db.requests);
                this.setData('mre_secure_settings', this.db.settings);
                this.setData('mre_secure_audit', this.db.auditLog);
            }

            // Audit logging
            logAudit(action, details = {}) {
                const auditEntry = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    userId: this.currentUser?.id,
                    userName: this.currentUser?.name,
                    action: action,
                    details: details,
                    ipAddress: 'localhost', // In real app, get actual IP
                    userAgent: navigator.userAgent,
                    fingerprint: this.fingerprint
                };
                
                this.db.auditLog.push(auditEntry);
                this.saveSecureDatabase();
            }

            // Rate limiting
            checkRateLimit(action, limit = 5, window = 60000) {
                const key = `${action}_${this.currentUser?.id || 'anonymous'}`;
                const now = Date.now();
                const attempts = this.rateLimiter.get(key) || [];
                
                // Clean old attempts
                const validAttempts = attempts.filter(time => now - time < window);
                
                if (validAttempts.length >= limit) {
                    return false;
                }
                
                validAttempts.push(now);
                this.rateLimiter.set(key, validAttempts);
                return true;
            }

            init() {
                // Initialize geolocation
                this.initGeolocation();
                
                // Start clock
                this.updateClock();
                setInterval(() => this.updateClock(), 1000);
                
                // Setup enhanced activity monitoring
                this.setupEnhancedActivityMonitoring();
                
                // Initialize session management
                this.initSessionManagement();
                
                // Setup keyboard shortcuts
                this.setupKeyboardShortcuts();
                
                // Initialize weather widget
                this.updateWeather();
                setInterval(() => this.updateWeather(), 600000); // Every 10 minutes
                
                // Check for saved theme
                const savedTheme = this.getData('mre_theme');
                if (savedTheme === 'dark') {
                    this.darkMode = true;
                    document.body.setAttribute('data-theme', 'dark');
                    document.getElementById('themeIcon').textContent = '☀️';
                }
                
                // Check for remembered session
                this.checkRememberedSession();
            }

            initGeolocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            this.geoLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            };
                            this.verifyOfficeLocation();
                        },
                        error => {
                            console.warn('Geolocation error:', error);
                            this.updateLocationStatus('Location unavailable', false);
                        }
                    );
                }
            }

            verifyOfficeLocation() {
                // Check if user is within office radius (example coordinates)
                const officeLocation = { lat: 32.2217, lng: -110.9265 }; // Tucson, AZ
                const distance = this.calculateDistance(
                    this.geoLocation.lat,
                    this.geoLocation.lng,
                    officeLocation.lat,
                    officeLocation.lng
                );
                
                const withinOffice = distance < 0.5; // Within 0.5 km
                this.updateLocationStatus(
                    withinOffice ? 'Office Location Verified' : 'Remote Location',
                    withinOffice
                );
            }

            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of Earth in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }

            updateLocationStatus(text, verified) {
                const statusEl = document.getElementById('locationStatus');
                const dotEl = document.querySelector('.location-dot');
                
                if (statusEl) statusEl.textContent = text;
                if (dotEl) {
                    dotEl.style.background = verified ? 'var(--success)' : 'var(--warning)';
                }
            }

            setupEnhancedActivityMonitoring() {
                // Enhanced mouse tracking
                let mouseTimer;
                document.addEventListener('mousemove', (e) => {
                    if (!this.currentSession) return;
                    
                    this.mouseMovements++;
                    this.lastActivity = Date.now();
                    
                    // Track mouse position patterns for advanced analytics
                    if (!this.mousePattern) this.mousePattern = [];
                    this.mousePattern.push({ x: e.clientX, y: e.clientY, t: Date.now() });
                    if (this.mousePattern.length > 100) this.mousePattern.shift();
                    
                    clearTimeout(mouseTimer);
                    mouseTimer = setTimeout(() => {
                        this.mouseMovements = Math.max(0, this.mouseMovements - 1);
                    }, 5000);
                });

                // Enhanced keyboard tracking with pattern detection
                let keyTimer;
                let keyPattern = [];
                document.addEventListener('keydown', (e) => {
                    if (!this.currentSession) return;
                    
                    this.keystrokes++;
                    this.lastActivity = Date.now();
                    
                    // Track typing patterns
                    keyPattern.push(Date.now());
                    if (keyPattern.length > 2) {
                        const typingSpeed = keyPattern[keyPattern.length - 1] - keyPattern[keyPattern.length - 2];
                        this.averageTypingSpeed = (this.averageTypingSpeed || 0) * 0.9 + typingSpeed * 0.1;
                    }
                    if (keyPattern.length > 50) keyPattern.shift();
                    
                    clearTimeout(keyTimer);
                    keyTimer = setTimeout(() => {
                        this.keystrokes = Math.max(0, this.keystrokes - 1);
                    }, 5000);
                });

                // Window focus tracking
                document.addEventListener('visibilitychange', () => {
                    if (this.currentSession) {
                        const event = {
                            type: document.hidden ? 'window_hidden' : 'window_visible',
                            timestamp: Date.now()
                        };
                        
                        if (!this.currentSession.windowEvents) {
                            this.currentSession.windowEvents = [];
                        }
                        this.currentSession.windowEvents.push(event);
                        
                        // Log significant idle periods
                        if (!document.hidden) {
                            this.lastActivity = Date.now();
                        }
                    }
                });

                // Application focus tracking
                window.addEventListener('blur', () => {
                    if (this.currentSession) {
                        this.currentSession.appBlurred = true;
                    }
                });

                window.addEventListener('focus', () => {
                    if (this.currentSession) {
                        this.currentSession.appBlurred = false;
                        this.lastActivity = Date.now();
                    }
                });

                // Advanced idle detection
                setInterval(() => {
                    if (!this.currentSession) return;
                    
                    const idleThreshold = 5 * 60 * 1000; // 5 minutes
                    const timeSinceActivity = Date.now() - this.lastActivity;
                    
                    if (timeSinceActivity > idleThreshold) {
                        this.idleTime += 1000;
                        
                        // Auto-pause after extended idle
                        if (timeSinceActivity > 30 * 60 * 1000 && !this.currentSession.autoPaused) {
                            this.currentSession.autoPaused = true;
                            this.addNotification('Auto-paused due to inactivity', 'warning');
                        }
                    }
                    
                    // Update productivity score
                    this.updateProductivityScore();
                    
                    // Check for break reminders
                    this.checkBreakReminder();
                    
                    this.updateActivityDisplay();
                }, 1000);
            }

            updateProductivityScore() {
                if (!this.currentSession) return;
                
                const elapsed = Date.now() - new Date(this.currentSession.clockIn).getTime();
                const activeTime = elapsed - this.idleTime;
                const productivity = Math.round((activeTime / elapsed) * 100);
                
                this.productivityScore = productivity;
                
                // Award achievements based on productivity
                if (productivity >= 95 && elapsed > 2 * 60 * 60 * 1000) {
                    this.unlockAchievement('productivity_master', 'Productivity Master', 'Maintained 95%+ productivity for 2 hours');
                }
            }

            checkBreakReminder() {
                if (!this.breakReminders || !this.currentSession) return;
                
                const timeSinceBreak = Date.now() - this.lastBreakTime;
                const twoHours = 2 * 60 * 60 * 1000;
                
                if (timeSinceBreak >= twoHours) {
                    const reminder = document.getElementById('breakReminder');
                    if (reminder) {
                        reminder.style.display = 'block';
                        setTimeout(() => {
                            reminder.style.display = 'none';
                        }, 10000);
                    }
                    
                    this.lastBreakTime = Date.now();
                    this.addNotification('Time for a break! You\'ve been working for 2 hours.', 'info');
                }
            }

            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey) {
                        switch(e.key.toUpperCase()) {
                            case 'C':
                                e.preventDefault();
                                this.quickClockToggle();
                                break;
                            case 'B':
                                e.preventDefault();
                                if (this.currentSession) this.startBreak();
                                break;
                            case 'T':
                                e.preventDefault();
                                this.loadTimesheet();
                                break;
                            case 'V':
                                e.preventDefault();
                                this.startVoiceCommand();
                                break;
                            case 'D':
                                e.preventDefault();
                                this.toggleTheme();
                                break;
                        }
                    }
                });
            }

            initSessionManagement() {
                // Session timeout check
                setInterval(() => {
                    if (this.sessionToken && this.sessionExpiry) {
                        const remaining = this.sessionExpiry - Date.now();
                        
                        if (remaining <= 0) {
                            this.sessionTimeout();
                        } else {
                            const minutes = Math.floor(remaining / 60000);
                            const seconds = Math.floor((remaining % 60000) / 1000);
                            const timerEl = document.getElementById('sessionTimer');
                            if (timerEl) {
                                timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                            }
                            
                            // Warning at 5 minutes
                            if (remaining <= 5 * 60 * 1000 && remaining > 4 * 60 * 1000) {
                                this.addNotification('Session expires in 5 minutes', 'warning');
                            }
                        }
                    }
                }, 1000);
            }

            sessionTimeout() {
                this.logAudit('session_timeout');
                showToast('Session expired. Please login again.', 'warning');
                this.logout();
            }

            checkRememberedSession() {
                const savedSession = this.getData('mre_saved_session');
                if (savedSession) {
                    if (savedSession && savedSession.expiry > Date.now()) {
                        // Verify fingerprint
                        if (savedSession.fingerprint === this.fingerprint) {
                            this.sessionToken = savedSession.token;
                            this.sessionExpiry = savedSession.expiry;
                            this.currentUser = savedSession.user;
                            this.showApp();
                        } else {
                            this.removeData('mre_saved_session');
                        }
                    }
                }
            }

            removeData(key) {
                if (this.storageAvailable) {
                    localStorage.removeItem(key);
                } else {
                    delete this.memoryStorage[key];
                }
            }

            // Enhanced Authentication
            async login(email, password) {
                // Rate limiting
                if (!this.checkRateLimit('login', 5, 300000)) { // 5 attempts per 5 minutes
                    showToast('Too many login attempts. Please try again later.', 'error');
                    return false;
                }
                
                // Input validation
                const sanitizedEmail = this.sanitizer.sanitize(email);
                
                // Find user
                const user = this.db.users.find(u => 
                    (u.email === sanitizedEmail || u.employeeId === sanitizedEmail) &&
                    (!u.lockedUntil || new Date(u.lockedUntil) < new Date())
                );
                
                if (!user) {
                    this.logAudit('login_failed', { email: sanitizedEmail, reason: 'user_not_found' });
                    return false;
                }
                
                // Verify password
                const hashedPassword = await this.hashPassword(password);
                if (user.password !== hashedPassword) {
                    user.failedAttempts = (user.failedAttempts || 0) + 1;
                    
                    if (user.failedAttempts >= this.maxFailedAttempts) {
                        user.lockedUntil = new Date(Date.now() + this.lockoutTime).toISOString();
                        this.logAudit('account_locked', { userId: user.id, email: user.email });
                        showToast('Account locked due to multiple failed attempts.', 'error');
                    }
                    
                    this.saveSecureDatabase();
                    this.logAudit('login_failed', { userId: user.id, reason: 'invalid_password' });
                    return false;
                }
                
                // Reset failed attempts
                user.failedAttempts = 0;
                user.lastLogin = new Date().toISOString();
                
                // Check if 2FA is required
                if (user.twoFactorEnabled) {
                    this.pendingUser = user;
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('twofaSection').style.display = 'block';
                    return 'requires_2fa';
                }
                
                // Complete login
                return this.completeLogin(user);
            }

            completeLogin(user) {
                // Generate session
                this.sessionToken = this.generateSessionToken();
                this.sessionExpiry = Date.now() + this.sessionTimeout;
                this.currentUser = user;
                
                // Save session if remember me
                const rememberSession = {
                    token: this.sessionToken,
                    expiry: Date.now() + (30 * 24 * 60 * 60 * 1000), // 30 days
                    user: user,
                    fingerprint: this.fingerprint
                };
                this.setData('mre_saved_session', rememberSession);
                
                // Log successful login
                this.logAudit('login_success', { userId: user.id });
                
                // Update UI
                this.showApp();
                showToast(`Welcome back, ${user.name}!`, 'success');
                
                // Show session info
                document.getElementById('sessionInfo').style.display = 'block';
                
                return true;
            }

            // Generate 2FA code
            generate2FACode() {
                return Math.floor(100000 + Math.random() * 900000).toString();
            }

            // Simulate sending email (in production, this would call your email service)
            async sendEmail(to, subject, body) {
                console.log(`Email sent to ${to}:`);
                console.log(`Subject: ${subject}`);
                console.log(`Body: ${body}`);
                
                // Show simulation message
                showToast(`Verification code sent to ${to}`, 'info');
                
                return true;
            }

            // Send 2FA code via email
            async send2FACode(user) {
                const code = this.generate2FACode();
                
                // Store code temporarily (expires in 10 minutes)
                user.twoFactorCode = code;
                user.twoFactorExpiry = Date.now() + (10 * 60 * 1000);
                this.saveSecureDatabase();
                
                // Send email
                const subject = 'MRE SecureTime™ - Login Verification Code';
                const body = `
Hello ${user.name},

Your login verification code is: ${code}

This code will expire in 10 minutes.

If you didn't request this code, please contact your administrator immediately.

Best regards,
MRE SecureTime™ Security Team
                `;
                
                await this.sendEmail(user.email, subject, body);
                return code; // For demo purposes, return the code
            }

            verify2FA(code) {
                // In production, verify against actual TOTP
                const expectedCode = '123456'; // Demo code
                
                if (code === expectedCode) {
                    return this.completeLogin(this.pendingUser);
                } else {
                    showToast('Invalid 2FA code', 'error');
                    return false;
                }
            }

            showApp() {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').classList.add('active');
                
                // Update user info
                document.getElementById('userName').textContent = this.currentUser.name;
                document.getElementById('userRole').textContent = 
                    `${this.currentUser.type === 'salary' ? 'Salary' : 'Hourly'} ${this.currentUser.isAdmin ? '• Admin' : ''}`;
                document.getElementById('userAvatar').src = this.currentUser.photo;
                
                // Show earnings ticker for Logan
                if (this.currentUser.showEarnings) {
                    document.getElementById('earningsTicker').style.display = 'block';
                }
                
                // Load team presence
                this.loadTeamPresence();
                
                // Load default page
                if (this.currentUser.requiresTimesheet) {
                    this.loadTimeClock();
                } else {
                    this.loadDashboard();
                }
                
                // Initialize voice commands if enabled
                if (this.voiceCommandsEnabled && 'webkitSpeechRecognition' in window) {
                    this.initVoiceCommands();
                }
            }

            loadTeamPresence() {
                const teamEl = document.getElementById('teamPresence');
                const activeUsers = this.db.sessions
                    .filter(s => !s.clockOut)
                    .map(s => this.db.users.find(u => u.id === s.userId))
                    .filter(u => u && u.id !== this.currentUser.id)
                    .slice(0, 5);
                
                teamEl.innerHTML = activeUsers.map(user => `
                    <img src="${user.photo}" alt="${user.name}" 
                         class="team-member-avatar active" 
                         title="${user.name} - Active">
                `).join('');
            }

            // Enhanced Time Clock Functions
            loadTimeClock() {
                const main = document.getElementById('appMain');
                
                // Get today's session and stats
                const todaySession = this.getTodaySession();
                const isClocked = this.currentSession !== null;
                const weekStats = this.getWeekStats();
                
                main.innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">Time Clock</h1>
                        <p class="page-subtitle">Secure time tracking with advanced analytics</p>
                    </div>

                    <!-- Productivity Insights Panel -->
                    <div class="insights-panel">
                        <div class="insight-title">
                            <span>📊</span>
                            <span>Today's Insights</span>
                        </div>
                        <div class="insight-grid">
                            <div class="insight-card">
                                <div class="insight-value">${weekStats.avgProductivity}%</div>
                                <div class="insight-label">Avg Productivity</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-value">${weekStats.totalHours}h</div>
                                <div class="insight-label">Week Total</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-value">${weekStats.onTimeRate}%</div>
                                <div class="insight-label">On-Time Rate</div>
                            </div>
                            <div class="insight-card">
                                <div class="insight-value">${weekStats.breakCompliance}%</div>
                                <div class="insight-label">Break Compliance</div>
                            </div>
                        </div>
                    </div>

                    <div class="clock-display">
                        <div class="clock-time"></div>
                        <div class="clock-date"></div>
                        
                        <div class="clock-actions">
                            <button id="clockInBtn" class="btn clock-btn ${isClocked ? '' : 'btn-success'}" 
                                onclick="tracker.clockIn()" ${isClocked ? 'disabled' : ''}>
                                <span>🟢</span> Clock In
                            </button>
                            <button id="clockOutBtn" class="btn clock-btn btn-danger" 
                                onclick="tracker.clockOut()" ${!isClocked ? 'disabled' : ''}>
                                <span>🔴</span> Clock Out
                            </button>
                            <button id="breakBtn" class="btn clock-btn btn-warning" 
                                onclick="tracker.startBreak()" ${!isClocked ? 'disabled' : ''}>
                                <span>☕</span> Take Break
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-4">
                        <div class="status-card">
                            <div class="status-icon">⏱️</div>
                            <div class="status-label">Total Hours</div>
                            <div class="status-value" id="totalHours">0.00</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon">✅</div>
                            <div class="status-label">Active Time</div>
                            <div class="status-value success" id="activeTime">0.00</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon">⏸️</div>
                            <div class="status-label">Idle Time</div>
                            <div class="status-value warning" id="idleTime">0.00</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon">📈</div>
                            <div class="status-label">Productivity</div>
                            <div class="status-value ${this.productivityScore >= 80 ? 'success' : 'warning'}" id="productivity">${this.productivityScore}%</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Real-Time Activity Monitor</h3>
                        </div>
                        <div class="card-body">
                            <div class="activity-bar">
                                <div class="activity-fill" id="activityBar" style="width: ${this.productivityScore}%"></div>
                            </div>
                            
                            <div class="activity-indicators" style="margin-top: 20px;">
                                <div class="activity-indicator">
                                    <div class="indicator-value" id="mouseActivity">${this.mouseMovements}</div>
                                    <div class="indicator-label">Mouse Activity</div>
                                </div>
                                <div class="activity-indicator">
                                    <div class="indicator-value" id="keyboardActivity">${this.keystrokes}</div>
                                    <div class="indicator-label">Keyboard Activity</div>
                                </div>
                                <div class="activity-indicator">
                                    <div class="indicator-value" id="focusStatus">${document.hidden ? 'Hidden' : 'Active'}</div>
                                    <div class="indicator-label">Window Status</div>
                                </div>
                                <div class="activity-indicator">
                                    <div class="indicator-value" id="idleTimer">0:00</div>
                                    <div class="indicator-label">Idle Timer</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-3">
                                <button class="btn btn-primary" onclick="tracker.showManualTimeRequest()">
                                    📝 Request Time Entry
                                </button>
                                <button class="btn btn-primary" onclick="tracker.showProjectAllocation()">
                                    📊 Allocate Time
                                </button>
                                <button class="btn btn-primary" onclick="tracker.viewAnalytics()">
                                    📈 View Analytics
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                // Update displays
                this.updateClock();
                this.updateActivityDisplay();
            }

            clockIn() {
                // Verify location
                if (!this.geoLocation) {
                    showToast('Location verification required. Please enable location services.', 'error');
                    return;
                }
                
                const now = new Date();
                this.currentSession = {
                    userId: this.currentUser.id,
                    clockIn: now.toISOString(),
                    clockOut: null,
                    breaks: [],
                    idleTime: 0,
                    activeTime: 0,
                    mouseActivity: 0,
                    keyboardActivity: 0,
                    location: { ...this.geoLocation },
                    windowEvents: [],
                    productivityScore: 100
                };

                this.idleTime = 0;
                this.lastActivity = Date.now();
                this.lastBreakTime = Date.now();
                
                // Update UI
                document.getElementById('clockInBtn').disabled = true;
                document.getElementById('clockOutBtn').disabled = false;
                document.getElementById('breakBtn').disabled = false;
                
                // Log audit
                this.logAudit('clock_in', {
                    location: this.geoLocation,
                    time: now.toISOString()
                });
                
                // Achievement check
                const earlyBird = now.getHours() < 8;
                if (earlyBird) {
                    this.unlockAchievement('early_bird', 'Early Bird', 'Clocked in before 8 AM');
                }
                
                showToast('Successfully clocked in!', 'success');
                this.addNotification('You have clocked in for the day', 'success');
            }

            clockOut() {
                if (!this.currentSession) return;

                this.currentSession.clockOut = new Date().toISOString();
                this.currentSession.idleTime = this.idleTime;
                this.currentSession.mouseActivity = this.mouseMovements;
                this.currentSession.keyboardActivity = this.keystrokes;
                this.currentSession.productivityScore = this.productivityScore;

                // Save session
                this.db.sessions.push(this.currentSession);
                this.saveSecureDatabase();
                
                // Log audit
                this.logAudit('clock_out', {
                    sessionId: this.currentSession.id,
                    duration: new Date(this.currentSession.clockOut) - new Date(this.currentSession.clockIn)
                });

                // Reset
                this.currentSession = null;
                this.idleTime = 0;
                this.mouseMovements = 0;
                this.keystrokes = 0;

                // Update UI
                document.getElementById('clockInBtn').disabled = false;
                document.getElementById('clockOutBtn').disabled = true;
                document.getElementById('breakBtn').disabled = true;
                
                showToast('Successfully clocked out!', 'success');
                this.addNotification('You have clocked out for the day', 'success');
                
                // Refresh display
                this.loadTimeClock();
            }

            startBreak() {
                if (!this.currentSession) return;
                
                const breakStart = new Date().toISOString();
                this.currentSession.breaks.push({
                    start: breakStart,
                    end: null
                });
                
                document.getElementById('breakBtn').textContent = '⏸️ End Break';
                document.getElementById('breakBtn').onclick = () => this.endBreak();
                
                this.lastBreakTime = Date.now();
                showToast('Break started. Enjoy your rest!', 'success');
            }

            endBreak() {
                if (!this.currentSession || this.currentSession.breaks.length === 0) return;
                
                const currentBreak = this.currentSession.breaks[this.currentSession.breaks.length - 1];
                currentBreak.end = new Date().toISOString();
                
                document.getElementById('breakBtn').textContent = '☕ Take Break';
                document.getElementById('breakBtn').onclick = () => this.startBreak();
                
                showToast('Break ended. Welcome back!', 'success');
            }

            // Voice Commands
            initVoiceCommands() {
                this.recognition = new webkitSpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = false;
                this.recognition.lang = 'en-US';
                
                this.recognition.onresult = (event) => {
                    const command = event.results[0][0].transcript.toLowerCase();
                    this.processVoiceCommand(command);
                };
                
                this.recognition.onerror = (event) => {
                    console.error('Voice recognition error:', event.error);
                    document.getElementById('voiceIndicator').style.display = 'none';
                };
                
                this.recognition.onend = () => {
                    document.getElementById('voiceIndicator').style.display = 'none';
                };
            }

            startVoiceCommand() {
                if (!this.recognition) {
                    showToast('Voice commands not supported in your browser', 'error');
                    return;
                }
                
                document.getElementById('voiceIndicator').style.display = 'block';
                this.recognition.start();
            }

            processVoiceCommand(command) {
                console.log('Voice command:', command);
                
                if (command.includes('clock in')) {
                    this.clockIn();
                } else if (command.includes('clock out')) {
                    this.clockOut();
                } else if (command.includes('take break') || command.includes('start break')) {
                    this.startBreak();
                } else if (command.includes('end break')) {
                    this.endBreak();
                } else if (command.includes('show timesheet')) {
                    this.loadTimesheet();
                } else if (command.includes('show dashboard')) {
                    this.loadDashboard();
                } else if (command.includes('what time is it')) {
                    const time = new Date().toLocaleTimeString();
                    this.speak(`The time is ${time}`);
                } else {
                    showToast('Command not recognized. Try "Clock in" or "Show timesheet"', 'warning');
                }
            }

            speak(text) {
                const utterance = new SpeechSynthesisUtterance(text);
                speechSynthesis.speak(utterance);
            }

            // Weather Updates
            async updateWeather() {
                // Simulate weather data (in production, use real weather API)
                const weatherData = {
                    temp: Math.floor(65 + Math.random() * 25),
                    condition: ['☀️', '⛅', '☁️', '🌧️'][Math.floor(Math.random() * 4)]
                };
                
                const iconEl = document.getElementById('weatherIcon');
                const tempEl = document.getElementById('weatherTemp');
                
                if (iconEl) iconEl.textContent = weatherData.condition;
                if (tempEl) tempEl.textContent = `${weatherData.temp}°F`;
            }

            // Achievements System
            unlockAchievement(id, title, description) {
                if (this.achievements.includes(id)) return;
                
                this.achievements.push(id);
                
                const popup = document.getElementById('achievementPopup');
                document.getElementById('achievementTitle').textContent = title;
                document.getElementById('achievementText').textContent = description;
                
                popup.style.display = 'block';
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 5000);
                
                this.addNotification(`Achievement unlocked: ${title}`, 'success');
                
                // Save achievement
                if (!this.currentUser.achievements) {
                    this.currentUser.achievements = [];
                }
                this.currentUser.achievements.push({
                    id,
                    title,
                    description,
                    unlockedAt: new Date().toISOString()
                });
                this.saveSecureDatabase();
            }

            // Notifications System
            addNotification(message, type = 'info') {
                const notification = {
                    id: Date.now(),
                    message,
                    type,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                
                this.notifications.unshift(notification);
                this.updateNotificationBadge();
                
                // Show toast for important notifications
                if (type === 'error' || type === 'warning') {
                    showToast(message, type);
                }
            }

            updateNotificationBadge() {
                const unreadCount = this.notifications.filter(n => !n.read).length;
                // Update badge count in UI
            }

            toggleNotifications() {
                const center = document.getElementById('notificationCenter');
                const isVisible = center.style.display === 'block';
                
                center.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    this.renderNotifications();
                }
            }

            renderNotifications() {
                const list = document.getElementById('notificationList');
                
                if (this.notifications.length === 0) {
                    list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--gray);">No notifications</div>';
                    return;
                }
                
                list.innerHTML = this.notifications.map(n => `
                    <div class="notification-item ${n.read ? '' : 'unread'}" onclick="tracker.markNotificationRead(${n.id})">
                        <div style="font-weight: 600;">${n.message}</div>
                        <div style="font-size: 12px; color: var(--gray); margin-top: 4px;">
                            ${new Date(n.timestamp).toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }

            markNotificationRead(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification) {
                    notification.read = true;
                    this.updateNotificationBadge();
                    this.renderNotifications();
                }
            }

            clearAllNotifications() {
                this.notifications = [];
                this.renderNotifications();
                this.updateNotificationBadge();
            }

            // Enhanced Analytics
            getWeekStats() {
                const weekSessions = this.getWeekSessions();
                
                let totalHours = 0;
                let totalProductivity = 0;
                let onTimeCount = 0;
                let breakCompliance = 0;
                
                weekSessions.forEach(session => {
                    const hours = (new Date(session.clockOut || Date.now()) - new Date(session.clockIn)) / (1000 * 60 * 60);
                    totalHours += hours;
                    
                    totalProductivity += session.productivityScore || 80;
                    
                    // Check if on time (before 9 AM)
                    const clockInTime = new Date(session.clockIn);
                    if (clockInTime.getHours() < 9) {
                        onTimeCount++;
                    }
                    
                    // Check break compliance
                    if (hours > 4 && session.breaks && session.breaks.length > 0) {
                        breakCompliance++;
                    }
                });
                
                const sessionCount = weekSessions.length || 1;
                
                return {
                    totalHours: totalHours.toFixed(1),
                    avgProductivity: Math.round(totalProductivity / sessionCount),
                    onTimeRate: Math.round((onTimeCount / sessionCount) * 100),
                    breakCompliance: Math.round((breakCompliance / sessionCount) * 100)
                };
            }

            getWeekSessions() {
                const startOfWeek = new Date();
                startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                
                return this.db.sessions.filter(s => 
                    s.userId === this.currentUser.id && 
                    new Date(s.clockIn) >= startOfWeek
                );
            }

            getTodaySession() {
                const today = new Date().toDateString();
                return this.db.sessions.find(s => 
                    s.userId === this.currentUser.id && 
                    new Date(s.clockIn).toDateString() === today
                );
            }

            // Earnings Ticker Update (Logan Special)
            updateEarningsDisplay() {
                if (!this.currentUser.showEarnings || !this.currentSession) return;
                
                const hourlyRate = 28.55; // Logan's rate after June 2, 2025
                const elapsed = Date.now() - new Date(this.currentSession.clockIn).getTime();
                const hours = elapsed / (1000 * 60 * 60);
                const earnings = hours * hourlyRate;
                
                const earningsEl = document.getElementById('earningsAmount');
                if (earningsEl) {
                    earningsEl.textContent = `${earnings.toFixed(2)}`;
                }
            }

            updateActivityDisplay() {
                const mouseEl = document.getElementById('mouseActivity');
                const keyboardEl = document.getElementById('keyboardActivity');
                const focusEl = document.getElementById('focusStatus');
                const idleTimerEl = document.getElementById('idleTimer');
                const productivityEl = document.getElementById('productivity');
                const activityBarEl = document.getElementById('activityBar');

                if (mouseEl) mouseEl.textContent = this.mouseMovements;
                if (keyboardEl) keyboardEl.textContent = this.keystrokes;
                if (focusEl) focusEl.textContent = document.hidden ? 'Hidden' : 'Active';
                
                // Update idle timer
                if (idleTimerEl && this.currentSession) {
                    const idleSeconds = Math.floor((Date.now() - this.lastActivity) / 1000);
                    const minutes = Math.floor(idleSeconds / 60);
                    const seconds = idleSeconds % 60;
                    idleTimerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }

                // Update productivity
                if (productivityEl) {
                    productivityEl.textContent = this.productivityScore + '%';
                    productivityEl.className = `status-value ${this.productivityScore >= 80 ? 'success' : 'warning'}`;
                }
                
                if (activityBarEl) {
                    activityBarEl.style.width = this.productivityScore + '%';
                }
                
                // Update earnings for Logan
                this.updateEarningsDisplay();
            }

            // Quick Actions
            quickClockToggle() {
                if (this.currentSession) {
                    this.clockOut();
                } else {
                    this.clockIn();
                }
            }

            // Manual Time Request
            showManualTimeRequest() {
                const modalBody = `
                    <form id="manualTimeForm" onsubmit="tracker.submitManualTimeRequest(event)">
                        <div class="form-group">
                            <label class="form-label">Date</label>
                            <input type="date" class="form-control" id="requestDate" required 
                                   max="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Clock In Time</label>
                            <input type="time" class="form-control" id="requestClockIn" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Clock Out Time</label>
                            <input type="time" class="form-control" id="requestClockOut" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Break Duration (minutes)</label>
                            <input type="number" class="form-control" id="requestBreak" min="0" value="30">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Reason for Manual Entry</label>
                            <textarea class="form-control" id="requestReason" rows="3" required 
                                placeholder="Please explain why you need to add this time manually..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Send Request To</label>
                            <select class="form-control" id="requestApprover" required>
                                <option value="1">Rachael (Admin)</option>
                                <option value="4">Logan (Admin)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Attach Evidence (Optional)</label>
                            <input type="file" class="form-control" id="requestEvidence" 
                                   accept="image/*,.pdf,.doc,.docx">
                        </div>
                    </form>
                `;

                const modalFooter = `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" 
                            onclick="document.getElementById('manualTimeForm').dispatchEvent(new Event('submit'))">
                        Submit Request
                    </button>
                `;

                showModal('Request Manual Time Entry', modalBody, modalFooter);
            }

            submitManualTimeRequest(event) {
                event.preventDefault();
                
                const request = {
                    id: Date.now(),
                    userId: this.currentUser.id,
                    userName: this.currentUser.name,
                    date: document.getElementById('requestDate').value,
                    clockIn: document.getElementById('requestClockIn').value,
                    clockOut: document.getElementById('requestClockOut').value,
                    breakMinutes: parseInt(document.getElementById('requestBreak').value),
                    reason: this.sanitizer.sanitize(document.getElementById('requestReason').value),
                    approverId: parseInt(document.getElementById('requestApprover').value),
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    evidence: null // Would handle file upload in production
                };

                this.db.requests.push(request);
                this.saveSecureDatabase();
                
                this.logAudit('manual_time_request', { requestId: request.id });
                
                closeModal();
                showToast('Time entry request submitted successfully!', 'success');
                this.addNotification('Your manual time entry request has been submitted for approval', 'info');
            }

            // Project Time Allocation
            showProjectAllocation() {
                const modalBody = `
                    <div class="project-allocation">
                        <h4>Allocate Today's Time to Projects</h4>
                        <p style="margin-bottom: 20px;">Distribute your ${this.getTodayHours()} hours across projects:</p>
                        
                        <div id="projectAllocationList">
                            ${this.getProjectAllocationHTML()}
                        </div>
                        
                        <button class="btn btn-primary" onclick="tracker.addProjectRow()" style="margin-top: 16px;">
                            + Add Project
                        </button>
                        
                        <div style="margin-top: 20px; padding: 16px; background: var(--light); border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>Total Allocated:</span>
                                <span id="totalAllocated">0 hours</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                <span>Remaining:</span>
                                <span id="remainingHours">${this.getTodayHours()} hours</span>
                            </div>
                        </div>
                    </div>
                `;

                const modalFooter = `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="tracker.saveProjectAllocation()">
                        Save Allocation
                    </button>
                `;

                showModal('Project Time Allocation', modalBody, modalFooter);
            }

            getProjectAllocationHTML() {
                const projects = [
                    'Client Meeting',
                    'Development',
                    'Documentation',
                    'Code Review',
                    'Testing',
                    'Planning'
                ];

                return projects.slice(0, 3).map((project, index) => `
                    <div class="time-entry-row" style="margin-bottom: 12px;">
                        <select class="form-control" style="flex: 2;">
                            <option>${project}</option>
                            ${projects.map(p => `<option value="${p}">${p}</option>`).join('')}
                        </select>
                        <input type="number" class="form-control" placeholder="Hours" step="0.25" 
                               min="0" max="24" style="flex: 1;" onchange="tracker.updateAllocationTotal()">
                        <button class="btn btn-danger" onclick="this.parentElement.remove(); tracker.updateAllocationTotal()">
                            ✕
                        </button>
                    </div>
                `).join('');
            }

            getTodayHours() {
                if (!this.currentSession) return '0.00';
                const elapsed = Date.now() - new Date(this.currentSession.clockIn).getTime();
                return (elapsed / (1000 * 60 * 60)).toFixed(2);
            }

            addProjectRow() {
                const container = document.getElementById('projectAllocationList');
                const row = document.createElement('div');
                row.className = 'time-entry-row';
                row.style.marginBottom = '12px';
                row.innerHTML = `
                    <select class="form-control" style="flex: 2;">
                        <option>Select Project</option>
                        <option>Client Meeting</option>
                        <option>Development</option>
                        <option>Documentation</option>
                        <option>Code Review</option>
                        <option>Testing</option>
                        <option>Planning</option>
                    </select>
                    <input type="number" class="form-control" placeholder="Hours" step="0.25" 
                           min="0" max="24" style="flex: 1;" onchange="tracker.updateAllocationTotal()">
                    <button class="btn btn-danger" onclick="this.parentElement.remove(); tracker.updateAllocationTotal()">
                        ✕
                    </button>
                `;
                container.appendChild(row);
            }

            updateAllocationTotal() {
                const inputs = document.querySelectorAll('#projectAllocationList input[type="number"]');
                let total = 0;
                inputs.forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                
                const todayHours = parseFloat(this.getTodayHours());
                document.getElementById('totalAllocated').textContent = `${total.toFixed(2)} hours`;
                document.getElementById('remainingHours').textContent = `${(todayHours - total).toFixed(2)} hours`;
            }

            saveProjectAllocation() {
                const allocations = [];
                const rows = document.querySelectorAll('#projectAllocationList .time-entry-row');
                
                rows.forEach(row => {
                    const project = row.querySelector('select').value;
                    const hours = parseFloat(row.querySelector('input').value) || 0;
                    
                    if (project && hours > 0) {
                        allocations.push({ project, hours });
                    }
                });

                if (allocations.length > 0) {
                    // Save allocations
                    if (!this.currentSession.projectAllocations) {
                        this.currentSession.projectAllocations = [];
                    }
                    this.currentSession.projectAllocations.push({
                        timestamp: new Date().toISOString(),
                        allocations: allocations
                    });
                    
                    this.logAudit('project_allocation', { allocations });
                    closeModal();
                    showToast('Project allocations saved successfully!', 'success');
                } else {
                    showToast('Please allocate at least one project', 'error');
                }
            }

            // Analytics View
            viewAnalytics() {
                const modalBody = `
                    <div class="analytics-view">
                        <h4>Productivity Analytics</h4>
                        
                        <div class="analytics-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
                            <div class="analytics-card" style="background: var(--light); padding: 20px; border-radius: 12px;">
                                <h5>Work Patterns</h5>
                                <div style="margin-top: 12px;">
                                    <div>Most Productive Hour: <strong>10-11 AM</strong></div>
                                    <div>Average Session Length: <strong>3.5 hours</strong></div>
                                    <div>Preferred Break Time: <strong>12:30 PM</strong></div>
                                </div>
                            </div>
                            
                            <div class="analytics-card" style="background: var(--light); padding: 20px; border-radius: 12px;">
                                <h5>Activity Metrics</h5>
                                <div style="margin-top: 12px;">
                                    <div>Avg Keystrokes/Hour: <strong>2,847</strong></div>
                                    <div>Avg Mouse Actions/Hour: <strong>1,234</strong></div>
                                    <div>Focus Sessions: <strong>4-6 per day</strong></div>
                                </div>
                            </div>
                            
                            <div class="analytics-card" style="background: var(--light); padding: 20px; border-radius: 12px;">
                                <h5>Efficiency Score</h5>
                                <div style="font-size: 48px; font-weight: 700; color: var(--success); text-align: center; margin: 20px 0;">
                                    92%
                                </div>
                                <div style="text-align: center; color: var(--gray);">Above Average</div>
                            </div>
                            
                            <div class="analytics-card" style="background: var(--light); padding: 20px; border-radius: 12px;">
                                <h5>Recommendations</h5>
                                <ul style="font-size: 14px; margin-top: 12px;">
                                    <li>• Take more frequent short breaks</li>
                                    <li>• Optimize morning productivity window</li>
                                    <li>• Reduce afternoon idle time</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;

                showModal('Productivity Analytics', modalBody);
            }

            // Dashboard for Admin Users
            loadDashboard() {
                const main = document.getElementById('appMain');
                const stats = this.calculateDashboardStats();
                
                main.innerHTML = `
                    <div class="page-header">
                        <h1 class="page-title">Executive Dashboard</h1>
                        <p class="page-subtitle">Real-time workforce analytics and insights</p>
                    </div>

                    <div class="grid grid-cols-4">
                        <div class="status-card">
                            <div class="status-icon">👥</div>
                            <div class="status-label">Active Now</div>
                            <div class="status-value">${stats.activeEmployees}</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon">⏰</div>
                            <div class="status-label">Total Hours Today</div>
                            <div class="status-value">${stats.totalHoursToday.toFixed(1)}</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon">📈</div>
                            <div class="status-label">Avg Productivity</div>
                            <div class="status-value ${stats.avgProductivity >= 80 ? 'success' : 'warning'}">${stats.avgProductivity}%</div>
                        </div>
                        
                        <div class="status-card">
                            <div class="status-icon">📝</div>
                            <div class="status-label">Pending Requests</div>
                            <div class="status-value warning">${stats.pendingRequests}</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2" style="margin-top: 24px;">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Live Activity Feed</h3>
                            </div>
                            <div class="card-body">
                                ${this.renderActivityFeed()}
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">Team Performance</h3>
                            </div>
                            <div class="card-body">
                                ${this.renderTeamPerformance()}
                            </div>
                        </div>
                    </div>

                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">Security Audit Log</h3>
                        </div>
                        <div class="card-body">
                            ${this.renderSecurityLog()}
                        </div>
                    </div>
                `;
            }

            calculateDashboardStats() {
                const today = new Date().toDateString();
                const todaySessions = this.db.sessions.filter(s => 
                    new Date(s.clockIn).toDateString() === today
                );

                let activeEmployees = 0;
                let totalHoursToday = 0;
                let totalProductivity = 0;

                // Count active sessions
                const activeSessions = todaySessions.filter(s => !s.clockOut);
                activeEmployees = activeSessions.length;

                // Calculate total hours and productivity
                todaySessions.forEach(session => {
                    const hours = session.clockOut ? 
                        (new Date(session.clockOut) - new Date(session.clockIn)) / (1000 * 60 * 60) :
                        (Date.now() - new Date(session.clockIn)) / (1000 * 60 * 60);
                    
                    totalHoursToday += hours;
                    totalProductivity += session.productivityScore || 80;
                });

                const avgProductivity = todaySessions.length > 0 ? 
                    Math.round(totalProductivity / todaySessions.length) : 0;

                const pendingRequests = this.db.requests.filter(r => r.status === 'pending').length;

                return {
                    activeEmployees,
                    totalHoursToday,
                    avgProductivity,
                    pendingRequests
                };
            }

            renderActivityFeed() {
                const recentEvents = this.db.auditLog
                    .slice(-10)
                    .reverse()
                    .map(event => {
                        const user = this.db.users.find(u => u.id === event.userId);
                        const timeAgo = this.getTimeAgo(new Date(event.timestamp));
                        
                        let icon = '📝';
                        let message = event.action;
                        
                        switch(event.action) {
                            case 'clock_in':
                                icon = '🟢';
                                message = 'clocked in';
                                break;
                            case 'clock_out':
                                icon = '🔴';
                                message = 'clocked out';
                                break;
                            case 'login_success':
                                icon = '🔐';
                                message = 'logged in';
                                break;
                            case 'manual_time_request':
                                icon = '📝';
                                message = 'requested manual time entry';
                                break;
                        }
                        
                        return `
                            <div style="padding: 12px 0; border-bottom: 1px solid var(--light);">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 20px;">${icon}</span>
                                    <div style="flex: 1;">
                                        <strong>${user?.name || 'System'}</strong> ${message}
                                        <div style="font-size: 12px; color: var(--gray);">${timeAgo}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                return recentEvents || '<p style="text-align: center; color: var(--gray);">No recent activity</p>';
            }

            renderTeamPerformance() {
                const hourlyEmployees = this.db.users.filter(u => u.type === 'hourly');
                
                return hourlyEmployees.map(employee => {
                    const todaySession = this.db.sessions.find(s => 
                        s.userId === employee.id && 
                        new Date(s.clockIn).toDateString() === new Date().toDateString()
                    );
                    
                    const status = todaySession ? 
                        (todaySession.clockOut ? 'Completed' : 'Active') : 
                        'Not Started';
                    
                    const productivity = todaySession?.productivityScore || 0;
                    
                    return `
                        <div style="padding: 16px; background: var(--light); border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <img src="${employee.photo}" alt="${employee.name}" 
                                         style="width: 40px; height: 40px; border-radius: 50%;">
                                    <div>
                                        <div style="font-weight: 600;">${employee.name}</div>
                                        <div style="font-size: 12px; color: var(--gray);">${status}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 24px; font-weight: 700; color: ${productivity >= 80 ? 'var(--success)' : 'var(--warning)'};">
                                        ${productivity}%
                                    </div>
                                    <div style="font-size: 12px; color: var(--gray);">Productivity</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderSecurityLog() {
                const securityEvents = this.db.auditLog
                    .filter(event => 
                        ['login_failed', 'account_locked', 'session_timeout', 'login_success'].includes(event.action)
                    )
                    .slice(-5)
                    .reverse();

                if (securityEvents.length === 0) {
                    return '<p style="text-align: center; color: var(--gray);">No security events</p>';
                }

                return `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Event</th>
                                <th>Details</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${securityEvents.map(event => {
                                const user = this.db.users.find(u => u.id === event.userId);
                                return `
                                    <tr>
                                        <td>${new Date(event.timestamp).toLocaleString()}</td>
                                        <td>${user?.name || event.details?.email || 'Unknown'}</td>
                                        <td>
                                            <span class="badge badge-${event.action === 'login_success' ? 'success' : 'warning'}">
                                                ${event.action.replace('_', ' ').toUpperCase()}
                                            </span>
                                        </td>
                                        <td>${event.details?.reason || '-'}</td>
                                        <td>${event.ipAddress || 'localhost'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            }

            getTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                if (seconds < 60) return 'just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
                return `${Math.floor(seconds / 86400)} days ago`;
            }

            // Secure Logout
            secureLogout() {
                if (this.currentSession) {
                    if (!confirm('You are currently clocked in. Are you sure you want to logout?')) {
                        return;
                    }
                    this.clockOut();
                }
                
                // Clear session
                this.sessionToken = null;
                this.sessionExpiry = null;
                this.currentUser = null;
                
                // Clear saved session
                this.removeData('mre_saved_session');
                
                // Log audit
                this.logAudit('logout');
                
                // Clear sensitive data
                this.mousePattern = [];
                this.notifications = [];
                
                // Redirect to login
                location.reload();
            }

            // Profile Management
            showProfile() {
                const modalBody = `
                    <div class="profile-view">
                        <div class="profile-header" style="text-align: center; margin-bottom: 32px;">
                            <img src="${this.currentUser.photo}" alt="${this.currentUser.name}" 
                                 style="width: 120px; height: 120px; border-radius: 50%; margin-bottom: 16px;">
                            <h3>${this.currentUser.name}</h3>
                            <p style="color: var(--gray);">${this.currentUser.email}</p>
                        </div>
                        
                        <div class="profile-section">
                            <h4>Account Information</h4>
                            <div class="profile-item">
                                <span>Employee ID:</span>
                                <strong>${this.currentUser.employeeId}</strong>
                            </div>
                            <div class="profile-item">
                                <span>Type:</span>
                                <strong>${this.currentUser.type === 'salary' ? 'Salary' : 'Hourly'}</strong>
                            </div>
                            <div class="profile-item">
                                <span>Role:</span>
                                <strong>${this.currentUser.isAdmin ? 'Administrator' : 'Employee'}</strong>
                            </div>
                            <div class="profile-item">
                                <span>Member Since:</span>
                                <strong>${new Date(this.currentUser.createdAt).toLocaleDateString()}</strong>
                            </div>
                        </div>
                        
                        <div class="profile-section" style="margin-top: 24px;">
                            <h4>Security Settings</h4>
                            <div class="profile-item">
                                <span>Two-Factor Authentication:</span>
                                <strong>${this.currentUser.twoFactorEnabled ? 'Enabled' : 'Disabled'}</strong>
                            </div>
                            <div class="profile-item">
                                <span>Last Login:</span>
                                <strong>${this.currentUser.lastLogin ? new Date(this.currentUser.lastLogin).toLocaleString() : 'N/A'}</strong>
                            </div>
                        </div>
                        
                        <div class="profile-section" style="margin-top: 24px;">
                            <h4>Achievements</h4>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px;">
                                ${(this.currentUser.achievements || []).map(a => `
                                    <div style="padding: 8px 16px; background: var(--light); border-radius: 20px;">
                                        🏆 ${a.title}
                                    </div>
                                `).join('') || '<p style="color: var(--gray);">No achievements yet</p>'}
                            </div>
                        </div>
                    </div>
                `;

                showModal('My Profile', modalBody);
            }

            showAchievements() {
                const achievements = [
                    { id: 'early_bird', icon: '🌅', title: 'Early Bird', description: 'Clock in before 8 AM', unlocked: false },
                    { id: 'productivity_master', icon: '💯', title: 'Productivity Master', description: 'Maintain 95%+ productivity for 2 hours', unlocked: false },
                    { id: 'perfect_week', icon: '⭐', title: 'Perfect Week', description: 'No late arrivals for a full week', unlocked: false },
                    { id: 'team_player', icon: '🤝', title: 'Team Player', description: 'Help 5 colleagues with time entries', unlocked: false },
                    { id: 'streak_champion', icon: '🔥', title: 'Streak Champion', description: '30 days perfect attendance', unlocked: false }
                ];

                const userAchievements = this.currentUser.achievements || [];
                
                const modalBody = `
                    <div class="achievements-view">
                        <h4>Your Achievements</h4>
                        <div class="achievements-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 24px;">
                            ${achievements.map(achievement => {
                                const isUnlocked = userAchievements.some(a => a.id === achievement.id);
                                return `
                                    <div class="achievement-card" style="
                                        padding: 20px;
                                        background: ${isUnlocked ? 'var(--light)' : '#f0f0f0'};
                                        border-radius: 12px;
                                        text-align: center;
                                        opacity: ${isUnlocked ? '1' : '0.5'};
                                    ">
                                        <div style="font-size: 48px; margin-bottom: 12px;">${achievement.icon}</div>
                                        <h5>${achievement.title}</h5>
                                        <p style="font-size: 14px; color: var(--gray); margin-top: 8px;">
                                            ${achievement.description}
                                        </p>
                                        ${isUnlocked ? '<div style="color: var(--success); margin-top: 8px;">✓ Unlocked</div>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;

                showModal('Achievements', modalBody);
            }

            showSettings() {
                const modalBody = `
                    <div class="settings-view">
                        <h4>Settings</h4>
                        
                        <div class="settings-section" style="margin-top: 24px;">
                            <h5>Notifications</h5>
                            <label style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
                                <input type="checkbox" ${this.breakReminders ? 'checked' : ''} 
                                       onchange="tracker.breakReminders = this.checked">
                                <span>Break reminders</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
                                <input type="checkbox" ${this.voiceCommandsEnabled ? 'checked' : ''} 
                                       onchange="tracker.voiceCommandsEnabled = this.checked">
                                <span>Voice commands</span>
                            </label>
                        </div>
                        
                        <div class="settings-section" style="margin-top: 24px;">
                            <h5>Security</h5>
                            <button class="btn btn-primary" onclick="tracker.changePassword()">
                                Change Password
                            </button>
                            <button class="btn btn-primary" onclick="tracker.enable2FA()" style="margin-left: 12px;">
                                ${this.currentUser.twoFactorEnabled ? 'Disable' : 'Enable'} 2FA
                            </button>
                        </div>
                        
                        <div class="settings-section" style="margin-top: 24px;">
                            <h5>Data & Privacy</h5>
                            <button class="btn btn-primary" onclick="tracker.exportMyData()">
                                Export My Data
                            </button>
                            <button class="btn btn-danger" onclick="tracker.deleteMyData()" style="margin-left: 12px;">
                                Delete My Data
                            </button>
                        </div>
                    </div>
                `;

                showModal('Settings', modalBody);
            }

            // Additional Security Functions
            changePassword() {
                const modalBody = `
                    <form onsubmit="tracker.updatePassword(event)">
                        <div class="form-group">
                            <label class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required 
                                   minlength="12" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*])(?=.{12,})">
                            <small style="color: var(--gray);">Minimum 12 characters, including uppercase, lowercase, number, and special character</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </form>
                `;

                showModal('Change Password', modalBody);
            }

            async updatePassword(event) {
                event.preventDefault();
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (newPassword !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }
                
                // Verify current password
                const hashedCurrent = await this.hashPassword(currentPassword);
                if (hashedCurrent !== this.currentUser.password) {
                    showToast('Current password is incorrect', 'error');
                    return;
                }
                
                // Update password
                this.currentUser.password = await this.hashPassword(newPassword);
                this.saveSecureDatabase();
                
                this.logAudit('password_changed');
                closeModal();
                showToast('Password updated successfully', 'success');
            }

            enable2FA() {
                this.currentUser.twoFactorEnabled = !this.currentUser.twoFactorEnabled;
                this.saveSecureDatabase();
                showToast(`Two-factor authentication ${this.currentUser.twoFactorEnabled ? 'enabled' : 'disabled'}`, 'success');
                this.showSettings();
            }

            exportMyData() {
                const userData = {
                    profile: { ...this.currentUser, password: undefined },
                    sessions: this.db.sessions.filter(s => s.userId === this.currentUser.id),
                    requests: this.db.requests.filter(r => r.userId === this.currentUser.id),
                    auditLog: this.db.auditLog.filter(a => a.userId === this.currentUser.id)
                };
                
                const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `mre_data_export_${this.currentUser.name.toLowerCase()}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showToast('Your data has been exported', 'success');
            }

            deleteMyData() {
                if (!confirm('Are you sure you want to delete all your data? This cannot be undone.')) {
                    return;
                }
                
                // This would be handled server-side in production
                showToast('Data deletion request submitted', 'info');
            }

            // Utility Functions
            updateClock() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                const dateStr = now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                const clockTime = document.querySelector('.clock-time');
                const clockDate = document.querySelector('.clock-date');
                
                if (clockTime) clockTime.textContent = timeStr;
                if (clockDate) clockDate.textContent = dateStr;

                // Update session time if clocked in
                if (this.currentSession) {
                    this.updateSessionTime();
                }
            }

            updateSessionTime() {
                if (!this.currentSession) return;

                const now = Date.now();
                const elapsed = now - new Date(this.currentSession.clockIn).getTime();
                const hours = elapsed / (1000 * 60 * 60);

                // Calculate break time
                let breakTime = 0;
                this.currentSession.breaks.forEach(brk => {
                    const start = new Date(brk.start);
                    const end = brk.end ? new Date(brk.end) : new Date();
                    breakTime += end - start;
                });

                const workTime = elapsed - breakTime;
                const activeTime = workTime - this.idleTime;

                // Update displays
                const totalHoursEl = document.getElementById('totalHours');
                const activeTimeEl = document.getElementById('activeTime');
                const idleTimeEl = document.getElementById('idleTime');

                if (totalHoursEl) totalHoursEl.textContent = (workTime / (1000 * 60 * 60)).toFixed(2);
                if (activeTimeEl) activeTimeEl.textContent = (activeTime / (1000 * 60 * 60)).toFixed(2);
                if (idleTimeEl) idleTimeEl.textContent = (this.idleTime / (1000 * 60 * 60)).toFixed(2);
            }
        }

        // Initialize the enhanced tracker
        const tracker = new SecureTimeTracker();

        // Global UI Functions
        function toggleTheme() {
            tracker.darkMode = !tracker.darkMode;
            document.body.setAttribute('data-theme', tracker.darkMode ? 'dark' : '');
            document.getElementById('themeIcon').textContent = tracker.darkMode ? '☀️' : '🌙';
            tracker.setData('mre_theme', tracker.darkMode ? 'dark' : 'light');
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            tracker.login(email, password).then(result => {
                if (result === 'requires_2fa') {
                    // 2FA flow is handled
                } else if (!result) {
                    showToast('Invalid credentials', 'error');
                    
                    // Clear password field
                    document.getElementById('loginPassword').value = '';
                    
                    // Update password strength indicator
                    updatePasswordStrength('');
                }
            });
        }

        function handle2FAInput(input, index) {
            if (input.value) {
                const inputs = document.querySelectorAll('.twofa-input');
                if (index < inputs.length - 1) {
                    inputs[index + 1].focus();
                } else {
                    // Auto-submit when all digits entered
                    verify2FA();
                }
            }
        }

        function verify2FA() {
            const inputs = document.querySelectorAll('.twofa-input');
            const code = Array.from(inputs).map(i => i.value).join('');
            
            if (code.length === 6) {
                tracker.verify2FA(code);
            } else {
                showToast('Please enter all 6 digits', 'error');
            }
        }

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordSection').style.display = 'block';
            document.getElementById('forgotStep1').style.display = 'block';
            document.getElementById('forgotStep2').style.display = 'none';
        }

        function backToLogin() {
            tracker.resetLogin();
        }

        function sendResetCode() {
            const email = document.getElementById('forgotEmail').value;
            if (!email) {
                showToast('Please enter your email address', 'error');
                return;
            }
            
            tracker.forgotPassword(email).then(success => {
                if (success) {
                    document.getElementById('forgotStep1').style.display = 'none';
                    document.getElementById('forgotStep2').style.display = 'block';
                }
            });
        }

        function completePasswordReset() {
            const email = document.getElementById('forgotEmail').value;
            const code = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (!code || !newPassword || !confirmPassword) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showToast('Password must be at least 8 characters long', 'error');
                return;
            }
            
            tracker.resetPassword(email, code, newPassword, rememberMe);
        }

        function updatePasswordStrength(password) {
            const strengthBar = document.getElementById('passwordStrength');
            if (!strengthBar) return;
            
            let strength = 0;
            let color = '#e74c3c';
            
            if (password.length >= 8) strength += 25;
            if (password.length >= 12) strength += 25;
            if (/[A-Z]/.test(password) && /[a-z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password) && /[^A-Za-z0-9]/.test(password)) strength += 25;
            
            if (strength <= 25) color = '#e74c3c';
            else if (strength <= 50) color = '#f39c12';
            else if (strength <= 75) color = '#f1c40f';
            else color = '#27ae60';
            
            strengthBar.style.width = strength + '%';
            strengthBar.style.background = color;
        }

        // Listen for password input
        document.addEventListener('input', (e) => {
            if (e.target.id === 'loginPassword') {
                updatePasswordStrength(e.target.value);
            }
        });

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            const icons = {
                success: '✓',
                error: '✕',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            icon.textContent = icons[type] || icons.info;
            msg.textContent = message;
            
            toast.className = `toast ${type} active`;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 4000);
        }

        function showModal(title, body, footer = '') {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalFooter').innerHTML = footer;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function toggleDropdown(element) {
            element.parentElement.classList.toggle('active');
        }

        function showShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'block';
        }

        function closeShortcuts() {
            document.getElementById('shortcutsModal').style.display = 'none';
        }

        function quickClockToggle() {
            tracker.quickClockToggle();
        }

        function startVoiceCommand() {
            tracker.startVoiceCommand();
        }

        function toggleNotifications() {
            tracker.toggleNotifications();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown').forEach(d => d.classList.remove('active'));
            }
        });

        // Prevent right-click context menu (security)
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            return false;
        });

        // Prevent text selection on sensitive elements
        document.addEventListener('selectstart', (e) => {
            if (e.target.closest('.password-field, .twofa-input, .session-info')) {
                e.preventDefault();
                return false;
            }
        });

        // Log page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (tracker.currentUser) {
                tracker.logAudit('visibility_change', { 
                    hidden: document.hidden,
                    timestamp: new Date().toISOString()
                });
            }
        });
    </script>
</body>
</html>