<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
<title>MRE Secure Timesheet System</title>
<style>
:root{--primary:#2563eb;--primary-dark:#1d4ed8;--success:#16a34a;--danger:#dc2626;--warning:#d97706;--info:#0ea5e9;--dark:#1f2937;--gray:#6b7280;--light:#f8fafc;--white:#ffffff;--border:#e5e7eb;--shadow:0 1px 3px 0 rgba(0,0,0,0.1);--shadow-lg:0 10px 15px -3px rgba(0,0,0,0.1)}*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--light);color:var(--dark);line-height:1.6}.security-badge{position:fixed;bottom:20px;left:20px;background:var(--success);color:white;padding:8px 16px;border-radius:20px;font-size:12px;z-index:100;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}.auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:20px}.auth-card{background:var(--white);border-radius:16px;box-shadow:var(--shadow-lg);width:100%;max-width:400px;overflow:hidden}.auth-header{background:var(--primary);color:white;padding:40px 30px;text-align:center}.auth-logo{width:80px;height:80px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 20px;font-size:36px}.auth-title{font-size:24px;font-weight:700;margin-bottom:8px}.auth-subtitle{opacity:0.9;font-size:14px}.auth-body{padding:30px}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:6px;font-weight:600;color:var(--dark)}.form-control{width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:8px;font-size:16px;transition:border-color 0.3s}.form-control:focus{outline:none;border-color:var(--primary)}.btn{padding:12px 24px;border:none;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s;display:inline-flex;align-items:center;justify-content:center;gap:8px;text-decoration:none}.btn:hover{transform:translateY(-1px)}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-dark)}.btn-success{background:var(--success);color:white}.btn-danger{background:var(--danger);color:white}.btn-warning{background:var(--warning);color:white}.btn-info{background:var(--info);color:white}.btn-secondary{background:var(--gray);color:white}.btn-small{padding:6px 12px;font-size:12px}.btn-block{width:100%}.app-container{display:none;min-height:100vh;background:var(--light)}.app-container.active{display:flex;flex-direction:column}.app-header{background:var(--white);box-shadow:var(--shadow);padding:16px 24px;display:flex;justify-content:space-between;align-items:center}.brand{display:flex;align-items:center;gap:12px;font-size:20px;font-weight:700;color:var(--primary)}.user-info{display:flex;align-items:center;gap:16px}.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;font-weight:600;cursor:pointer;overflow:hidden}.user-avatar img{width:100%;height:100%;object-fit:cover}.logout-btn{padding:8px 16px;font-size:14px}.app-main{flex:1;padding:24px;max-width:1200px;margin:0 auto;width:100%}.page-header{margin-bottom:32px;text-align:center}.page-title{font-size:28px;font-weight:700;color:var(--dark);margin-bottom:8px}.page-subtitle{color:var(--gray)}.card{background:var(--white);border-radius:12px;box-shadow:var(--shadow);overflow:hidden;margin-bottom:24px}.card-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.card-title{font-size:18px;font-weight:600}.card-body{padding:20px}.grid{display:grid;gap:24px}.grid-2{grid-template-columns:repeat(2,1fr)}.grid-3{grid-template-columns:repeat(3,1fr)}.status-badge{padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600;text-transform:uppercase}.status-active{background:#dcfce7;color:var(--success)}.status-vault{background:#dbeafe;color:var(--primary)}.status-archived{background:#f3f4f6;color:var(--gray)}.timesheet-table{width:100%;border-collapse:collapse;margin-top:16px}.timesheet-table th,.timesheet-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}.timesheet-table th{background:var(--light);font-weight:600}.timesheet-table input{border:1px solid var(--border);padding:6px 8px;border-radius:4px;width:100%}.total-row{font-weight:600;background:var(--light)}.earnings-highlight{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);color:var(--success);font-weight:700;font-size:16px}.auto-save{position:fixed;top:20px;right:20px;background:var(--success);color:white;padding:8px 16px;border-radius:20px;font-size:12px;opacity:0;transition:opacity 0.3s}.auto-save.saving{opacity:1}.overtime-warning{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:8px 12px;border-radius:6px;font-size:12px;font-weight:600;margin-top:8px}.toast{position:fixed;bottom:24px;right:24px;background:var(--dark);color:white;padding:16px 24px;border-radius:8px;box-shadow:var(--shadow-lg);display:none;z-index:1000}.toast.success{background:var(--success)}.toast.error{background:var(--danger)}.toast.warning{background:var(--warning)}.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}.modal-content{background:var(--white);border-radius:12px;width:100%;max-width:800px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg)}.modal-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.modal-title{font-size:18px;font-weight:600}.modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--gray)}.modal-body{padding:20px}.modal-footer{padding:20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px}.nav-tabs{display:flex;border-bottom:2px solid var(--border);margin-bottom:24px;flex-wrap:wrap}.nav-tab{padding:12px 24px;background:none;border:none;color:var(--gray);cursor:pointer;font-weight:500;border-bottom:2px solid transparent;transition:all 0.3s;white-space:nowrap}.nav-tab:hover{color:var(--primary)}.nav-tab.active{color:var(--primary);border-bottom-color:var(--primary)}.tab-content{display:none}.tab-content.active{display:block}.period-group{margin-bottom:32px}.period-header{background:var(--primary);color:white;padding:16px 20px;border-radius:8px 8px 0 0;font-weight:600;font-size:18px}.period-content{background:var(--white);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px}.timesheet-item{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.timesheet-item:last-child{border-bottom:none}.timesheet-info{flex:1}.timesheet-actions{display:flex;gap:8px}.vault-indicator{background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--primary);font-weight:600}.archive-indicator{background:#f9fafb;border:1px solid #d1d5db;border-radius:6px;padding:8px 12px;font-size:12px;color:var(--gray);font-weight:600}.export-buttons{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}.filter-section{background:var(--white);padding:20px;border-radius:12px;box-shadow:var(--shadow);margin-bottom:24px}.quick-actions{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}.quick-action-btn{padding:8px 16px;font-size:14px;border-radius:20px}.profile-section{border-bottom:1px solid var(--border);padding-bottom:20px;margin-bottom:20px}.profile-section:last-child{border-bottom:none;margin-bottom:0}.profile-photo-upload{display:flex;align-items:center;gap:16px;margin-bottom:16px}.profile-photo-preview{width:80px;height:80px;border-radius:50%;background:var(--light);display:flex;align-items:center;justify-content:center;font-size:32px;overflow:hidden}.profile-photo-preview img{width:100%;height:100%;object-fit:cover}.earnings-summary{background:linear-gradient(135deg,#dcfce7 0%,#bbf7d0 100%);border-radius:12px;padding:20px;margin-bottom:20px}.earnings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px}.earnings-item{text-align:center}.earnings-value{font-size:24px;font-weight:700;color:var(--success);margin-bottom:4px}.earnings-label{font-size:12px;color:var(--dark);opacity:0.8}.bulk-actions{background:var(--light);padding:16px;border-radius:8px;margin-bottom:24px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}.time-off-section{margin-top:20px;padding:16px;background:#f8fafc;border-radius:8px;border:1px solid var(--border)}.time-off-header{font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px;color:var(--dark)}.time-off-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}.time-off-option{padding:12px;background:var(--white);border-radius:6px;border:1px solid var(--border)}.time-off-checkbox{display:flex;align-items:center;gap:8px;margin-bottom:8px}.time-off-checkbox input[type="checkbox"]{width:16px;height:16px}.time-off-hours{display:none;margin-top:8px}.time-off-hours.visible{display:block}.time-off-hours select{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:14px}.file-item{padding:8px 16px;cursor:pointer;border-bottom:1px solid var(--border)}.file-item:hover{background:var(--primary);color:white}.file-item.active{background:var(--primary);color:white}.code-editor-dark{background:#1e1e1e;color:#d4d4d4}.admin-warning{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:12px;border-radius:6px;margin-bottom:16px;font-weight:600}.security-indicator{position:fixed;top:20px;left:20px;background:var(--success);color:white;padding:8px 12px;border-radius:4px;font-size:11px;z-index:100}.no-select{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.empty-state{text-align:center;padding:60px 20px;color:var(--gray)}.empty-state-icon{font-size:48px;margin-bottom:16px;opacity:0.5}.photo-upload-area{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all 0.3s}.photo-upload-area:hover{border-color:var(--primary);background:var(--light)}.photo-upload-area.dragover{border-color:var(--primary);background:#eff6ff}@media (max-width:768px){.grid-2,.grid-3{grid-template-columns:1fr}.app-header{padding:12px 16px;flex-direction:column;gap:12px}.app-main{padding:16px}.timesheet-table{font-size:14px}.nav-tabs{overflow-x:auto;-webkit-overflow-scrolling:touch}.timesheet-item{flex-direction:column;align-items:flex-start;gap:12px}.timesheet-actions{width:100%;justify-content:flex-start}.export-buttons{justify-content:center}.quick-actions{justify-content:center}.earnings-grid{grid-template-columns:repeat(2,1fr)}}
</style>
</head>
<body>
<div class="security-badge">🔒 AES-256 Encrypted</div>
<div class="security-indicator">Session Secure</div>
<div class="auto-save" id="autoSaveIndicator">💾 Auto-saving...</div>
<div class="auth-container" id="authContainer">
<div class="auth-card">
<div class="auth-header">
<div class="auth-logo">📋</div>
<h1 class="auth-title">MRE Timesheet</h1>
<p class="auth-subtitle">Secure Employee Time Tracking</p>
</div>
<div class="auth-body">
<form id="loginForm" onsubmit="handleLogin(event)">
<div class="form-group">
<label class="form-label">Email or Employee ID</label>
<input type="text" class="form-control" id="loginEmail" required autocomplete="username">
</div>
<div class="form-group">
<label class="form-label">Password</label>
<input type="password" class="form-control" id="loginPassword" required autocomplete="current-password">
</div>
<div class="form-group">
<label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
<input type="checkbox" id="adminAccess">
<span style="font-size:14px;">🔧 Admin Access Mode (Logan Only)</span>
</label>
</div>
<div class="form-group">
<button type="submit" class="btn btn-primary btn-block">🔐 Sign In Securely</button>
</div>
</form>
</div>
</div>
</div>
<div class="app-container" id="appContainer">
<header class="app-header">
<div class="brand">
<span>📋</span>
<span>MRE Timesheet System</span>
</div>
<div class="user-info">
<div class="user-avatar" id="userAvatar" onclick="timesheet.showProfile()"></div>
<div>
<div id="userName" style="font-weight:600;"></div>
<div id="userRole" style="font-size:12px;color:var(--gray);"></div>
</div>
<button class="btn btn-secondary logout-btn" onclick="timesheet.logout()">🚪 Logout</button>
</div>
</header>
<main class="app-main" id="appMain">
<div class="quick-actions">
<button class="btn btn-primary quick-action-btn" onclick="timesheet.quickTimeEntry()">⚡ Quick Entry</button>
<button class="btn btn-success quick-action-btn" onclick="timesheet.copyLastWeek()">📋 Copy Last Week</button>
<button class="btn btn-info quick-action-btn" onclick="timesheet.showProfile()">👤 My Profile</button>
<button class="btn btn-warning quick-action-btn" id="bulkExportBtn" onclick="timesheet.bulkExport()" style="display:none;">📦 Bulk Export</button>
</div>
<div class="nav-tabs">
<button class="nav-tab active" onclick="showTab('current-timesheets')">📋 Current Timesheets</button>
<button class="nav-tab" onclick="showTab('my-vault')">🗄️ My Vault</button>
<button class="nav-tab" onclick="showTab('my-archive')">📦 My Archive</button>
<button class="nav-tab" id="managerVaultTab" onclick="showTab('manager-vault')" style="display:none;">👥 All Vaults</button>
<button class="nav-tab" id="managerArchiveTab" onclick="showTab('manager-archive')" style="display:none;">📚 All Archives</button>
<button class="nav-tab" id="adminTab" onclick="showTab('admin-panel')" style="display:none;">🔧 Admin Panel</button>
</div>
<div id="current-timesheets" class="tab-content active">
<div class="page-header">
<h1 class="page-title">Current Pay Periods</h1>
<p class="page-subtitle">Enter your hours for the current two-week periods</p>
</div>
<div class="earnings-summary" id="earningsSummary">
<h3 style="margin-bottom:16px;display:flex;align-items:center;gap:8px;">
<span>💰</span>
<span>Current Period Earnings</span>
</h3>
<div class="earnings-grid" id="earningsGrid"></div>
</div>
<div class="grid grid-2" id="activeTimesheets"></div>
</div>
<div id="my-vault" class="tab-content">
<div class="page-header">
<h1 class="page-title">My Vault</h1>
<p class="page-subtitle">My completed timesheets (2-4 weeks old)</p>
</div>
<div id="myVaultContent"></div>
</div>
<div id="my-archive" class="tab-content">
<div class="page-header">
<h1 class="page-title">My Archive</h1>
<p class="page-subtitle">My historical timesheets (4+ weeks old)</p>
</div>
<div id="myArchiveContent"></div>
</div>
<div id="manager-vault" class="tab-content">
<div class="page-header">
<h1 class="page-title">All Employee Vaults</h1>
<p class="page-subtitle">All completed timesheets (2-4 weeks old)</p>
</div>
<div class="bulk-actions">
<label style="font-weight:600;">Bulk Actions:</label>
<button class="btn btn-success btn-small" onclick="timesheet.bulkEmailAll('vault')">📧 Email All Vault</button>
<button class="btn btn-primary btn-small" onclick="timesheet.bulkExportAll('vault')">📥 Export All Vault</button>
</div>
<div class="filter-section">
<label class="form-label">Filter by Employee:</label>
<select id="vaultEmployeeFilter" class="form-control" onchange="timesheet.filterManagerVault()">
<option value="">All Employees</option>
</select>
</div>
<div id="managerVaultContent"></div>
</div>
<div id="manager-archive" class="tab-content">
<div class="page-header">
<h1 class="page-title">All Employee Archives</h1>
<p class="page-subtitle">All historical timesheets (4+ weeks old)</p>
</div>
<div class="bulk-actions">
<label style="font-weight:600;">Bulk Actions:</label>
<button class="btn btn-success btn-small" onclick="timesheet.bulkEmailAll('archive')">📧 Email All Archive</button>
<button class="btn btn-primary btn-small" onclick="timesheet.bulkExportAll('archive')">📥 Export All Archive</button>
<button class="btn btn-info btn-small" onclick="timesheet.generatePayrollReport()">📊 Generate Payroll Report</button>
</div>
<div class="filter-section">
<label class="form-label">Filter by Employee:</label>
<select id="archiveEmployeeFilter" class="form-control" onchange="timesheet.filterManagerArchive()">
<option value="">All Employees</option>
</select>
</div>
<div id="managerArchiveContent"></div>
</div>
<div id="admin-panel" class="tab-content">
<div class="page-header">
<h1 class="page-title">🔧 Admin Control Panel</h1>
<p class="page-subtitle">Real-time system management and code editor</p>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title">System Controls</h3>
</div>
<div class="card-body">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;">
<button class="btn btn-primary" onclick="timesheet.openCodeEditor()">📝 Code Editor</button>
<button class="btn btn-warning" onclick="timesheet.exportSystemData()">📤 Export All Data</button>
<button class="btn btn-danger" onclick="timesheet.resetSystem()">🔄 Reset System</button>
<button class="btn btn-info" onclick="timesheet.viewAuditLogs()">📋 Audit Logs</button>
</div>
</div>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title">User Management</h3>
</div>
<div class="card-body" id="userManagement"></div>
</div>
<div class="card">
<div class="card-header">
<h3 class="card-title">System Statistics</h3>
</div>
<div class="card-body" id="systemStats"></div>
</div>
</div>
</main>
</div>
<div class="modal" id="codeEditorModal" style="z-index:2000;">
<div class="modal-content" style="max-width:90vw;max-height:90vh;">
<div class="modal-header">
<h3 class="modal-title">🔧 Real-Time Code Editor</h3>
<div style="display:flex;gap:12px;">
<button class="btn btn-success btn-small" onclick="timesheet.applyCodeChanges()">✅ Apply Changes</button>
<button class="btn btn-warning btn-small" onclick="timesheet.previewChanges()">👁️ Preview</button>
<button class="modal-close" onclick="timesheet.closeCodeEditor()">×</button>
</div>
</div>
<div class="modal-body" style="padding:0;">
<div style="display:flex;height:70vh;">
<div style="width:200px;background:var(--light);border-right:1px solid var(--border);overflow-y:auto;">
<div style="padding:16px;border-bottom:1px solid var(--border);font-weight:600;">📁 System Files</div>
<div id="fileTree">
<div class="file-item" onclick="timesheet.loadFile('html')">📄 HTML Structure</div>
<div class="file-item" onclick="timesheet.loadFile('css')">🎨 CSS Styles</div>
<div class="file-item" onclick="timesheet.loadFile('js')">⚙️ JavaScript Logic</div>
<div class="file-item" onclick="timesheet.loadFile('users')">👥 User Data</div>
<div class="file-item" onclick="timesheet.loadFile('timesheets')">📋 Timesheet Data</div>
</div>
</div>
<div style="flex:1;display:flex;flex-direction:column;">
<div style="padding:12px 16px;background:var(--dark);color:white;font-size:12px;">
<span id="currentFile">📄 Select a file to edit</span>
</div>
<textarea id="codeEditor" style="flex:1;border:none;padding:16px;font-family:'Courier New',monospace;font-size:14px;resize:none;outline:none;background:#1e1e1e;color:#d4d4d4;" placeholder="Select a file from the tree to start editing..."></textarea>
</div>
</div>
</div>
</div>
</div>
<div class="toast" id="toast">
<span id="toastMessage"></span>
</div>
<div class="modal" id="modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="modalTitle"></h3>
<button class="modal-close" onclick="closeModal()">×</button>
</div>
<div class="modal-body" id="modalBody"></div>
<div class="modal-footer" id="modalFooter"></div>
</div>
</div>
<script>
class SecureTimesheetSystem{constructor(){this.db=this.initDatabase();this.currentUser=null;this.sessionToken=null;this.lastActivity=Date.now();this.autoSaveTimeout=null;this.vaultCheckInterval=null;this.sessionTimeout=60*60*1000;this.failedAttempts=new Map();this.maxFailedAttempts=3;this.lockoutTime=15*60*1000;this.csrfToken=this.generateToken();this.adminMode=false;this.currentEditingFile=null;this.init()}initDatabase(){const storageAvailable=this.testStorage();if(storageAvailable){return{users:this.getSecureData('mre_ts_users')||this.initDefaultUsers(),timesheets:this.getSecureData('mre_ts_timesheets')||[],auditLog:this.getSecureData('mre_ts_audit')||[]}}else{return{users:this.initDefaultUsers(),timesheets:[],auditLog:[]}}}testStorage(){try{localStorage.setItem('test','test');localStorage.removeItem('test');return true}catch(e){console.warn('localStorage not available, using memory storage');return false}}getSecureData(key){try{const encrypted=localStorage.getItem(key);return encrypted?this.decrypt(encrypted):null}catch(e){return null}}setSecureData(key,value){try{localStorage.setItem(key,this.encrypt(value))}catch(e){console.warn('Could not save to localStorage')}}encrypt(data){return btoa(JSON.stringify(data))}decrypt(encrypted){return JSON.parse(atob(encrypted))}generateToken(){return btoa(Math.random().toString(36).substring(2)+Date.now())}generateSessionToken(){return this.generateToken()}async hashPassword(password){const encoder=new TextEncoder();const data=encoder.encode(password+'MRE_SALT_2024');const hash=await crypto.subtle.digest('SHA-256',data);return btoa(String.fromCharCode(...new Uint8Array(hash)))}initDefaultUsers(){return[{id:1,name:'Rachael',email:'mrselectrictucson@gmail.com',employeeId:'EMP001',isManager:true,hourlyRate:0.00,overtimeRate:0.00,isSalaried:true,photo:null,password:null,createdAt:new Date().toISOString()},{id:2,name:'Brad',email:'mr.electric.tucson@gmail.com',employeeId:'EMP002',isManager:true,hourlyRate:0.00,overtimeRate:0.00,isSalaried:true,photo:null,password:null,createdAt:new Date().toISOString()},{id:3,name:'Cherish',email:'mrelectriccherish@gmail.com',employeeId:'EMP003',isManager:true,hourlyRate:23.55,overtimeRate:35.33,isSalaried:false,photo:null,password:null,createdAt:new Date().toISOString()},{id:4,name:'Logan',email:'tucson@mrelectric.com',employeeId:'EMP004',isManager:true,hourlyRate:28.55,overtimeRate:42.83,isSalaried:false,photo:null,password:null,createdAt:new Date().toISOString()},{id:5,name:'Anastosia',email:'mrelectricoffice2@gmail.com',employeeId:'EMP005',isManager:false,hourlyRate:17.50,overtimeRate:26.25,isSalaried:false,photo:null,password:null,createdAt:new Date().toISOString()},{id:6,name:'Bryce',email:'mrelectricoffice3@gmail.com',employeeId:'EMP006',isManager:false,hourlyRate:17.35,overtimeRate:26.03,isSalaried:false,photo:null,password:null,createdAt:new Date().toISOString()},{id:7,name:'Ben',email:'mrelectricoffice4@gmail.com',employeeId:'EMP007',isManager:false,hourlyRate:17.00,overtimeRate:25.50,isSalaried:false,photo:null,password:null,createdAt:new Date().toISOString()}]}async init(){for(const user of this.db.users){if(!user.password){user.password=await this.hashPassword('SecurePass123!')}if(!user.hourlyRate&&user.hourlyRate!==0)user.hourlyRate=20.00;if(!user.overtimeRate&&user.overtimeRate!==0)user.overtimeRate=user.hourlyRate*1.5;if(user.isSalaried===undefined)user.isSalaried=false}this.saveDatabase();this.startConstantAutoSave();this.startVaultManagement();this.monitorSession();this.initializePayPeriods();this.checkExistingSession()}checkExistingSession(){const savedSession=this.getSecureData('mre_ts_session');if(savedSession&&savedSession.expiry>Date.now()){this.sessionToken=savedSession.token;this.currentUser=savedSession.user;this.adminMode=savedSession.adminMode||false;this.showApp()}}startConstantAutoSave(){document.addEventListener('input',(e)=>{if(e.target.matches('.timesheet-table input')&&this.currentUser){this.triggerAutoSave()}});setInterval(()=>{if(this.currentUser){this.autoSave()}},10000)}triggerAutoSave(){if(this.autoSaveTimeout){clearTimeout(this.autoSaveTimeout)}this.autoSaveTimeout=setTimeout(()=>{this.autoSave()},1000)}startVaultManagement(){this.vaultCheckInterval=setInterval(()=>{this.processVaultAndArchive()},60*60*1000);this.processVaultAndArchive()}processVaultAndArchive(){const now=new Date();const twoWeeksAgo=new Date(now.getTime()-(14*24*60*60*1000));const fourWeeksAgo=new Date(now.getTime()-(28*24*60*60*1000));this.db.timesheets.forEach(timesheet=>{const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);if(!period)return;const periodEndPlus1Day=new Date(period.endDate.getTime()+(24*60*60*1000));if(periodEndPlus1Day<=twoWeeksAgo&&periodEndPlus1Day>fourWeeksAgo){if(timesheet.status!=='vault'){timesheet.status='vault';timesheet.movedToVaultAt=now.toISOString();this.autoExportTimesheet(timesheet);this.logAudit('moved_to_vault',{timesheetId:timesheet.id,userId:timesheet.userId})}}else if(periodEndPlus1Day<=fourWeeksAgo){if(timesheet.status!=='archived'){timesheet.status='archived';timesheet.movedToArchiveAt=now.toISOString();this.logAudit('moved_to_archive',{timesheetId:timesheet.id,userId:timesheet.userId})}}else{if(!timesheet.status||timesheet.status==='vault'||timesheet.status==='archived'){timesheet.status='active'}}});this.saveDatabase()}autoExportTimesheet(timesheet){try{const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);if(user&&period){const adpData=this.generateADPFormat(timesheet,user,period);timesheet.autoExported=true;timesheet.exportedAt=new Date().toISOString();console.log(`Auto-exported timesheet for ${user.name} - Period: ${this.formatDate(period.startDate)} to ${this.formatDate(period.endDate)}`);this.logAudit('timesheet_auto_exported',{timesheetId:timesheet.id,userId:timesheet.userId,userEmail:user.email})}}catch(error){console.error('Auto-export failed:',error)}}autoSave(){const indicator=document.getElementById('autoSaveIndicator');indicator.classList.add('saving');this.saveDatabase();setTimeout(()=>{indicator.classList.remove('saving')},1000)}monitorSession(){setInterval(()=>{if(this.currentUser&&Date.now()-this.lastActivity>this.sessionTimeout){this.sessionExpired()}},60000);document.addEventListener('click',()=>this.lastActivity=Date.now());document.addEventListener('keypress',()=>this.lastActivity=Date.now())}sessionExpired(){this.logAudit('session_expired',{userId:this.currentUser.id});this.logout();showToast('Session expired for security','warning')}logAudit(action,details={}){const entry={id:Date.now(),timestamp:new Date().toISOString(),userId:this.currentUser?.id,action,details,ip:'localhost'};this.db.auditLog.push(entry);this.saveDatabase()}async login(email,password){const identifier=email.toLowerCase();const adminAccess=document.getElementById('adminAccess')?.checked;const attempts=this.failedAttempts.get(identifier)||{count:0,lastAttempt:0};if(attempts.count>=this.maxFailedAttempts){const timeLeft=this.lockoutTime-(Date.now()-attempts.lastAttempt);if(timeLeft>0){const minutes=Math.ceil(timeLeft/60000);showToast(`Account locked. Try again in ${minutes} minutes.`,'error');return false}else{this.failedAttempts.delete(identifier)}}const user=this.db.users.find(u=>u.email.toLowerCase()===identifier||u.employeeId.toLowerCase()===identifier);if(!user){this.handleFailedLogin(identifier,'Invalid credentials');return false}if(adminAccess&&user.employeeId!=='EMP004'){showToast('Admin access denied - Logan only','error');return false}const hashedPassword=await this.hashPassword(password);if(user.password!==hashedPassword){this.handleFailedLogin(identifier,'Invalid credentials');return false}this.failedAttempts.delete(identifier);this.currentUser=user;this.sessionToken=this.generateSessionToken();this.adminMode=adminAccess&&user.employeeId==='EMP004';this.setSecureData('mre_ts_session',{token:this.sessionToken,user:user,adminMode:this.adminMode,expiry:Date.now()+this.sessionTimeout});this.logAudit('login_success',{email:user.email,adminMode:this.adminMode});this.showApp();return true}handleFailedLogin(identifier,reason){const attempts=this.failedAttempts.get(identifier)||{count:0,lastAttempt:0};attempts.count++;attempts.lastAttempt=Date.now();this.failedAttempts.set(identifier,attempts);this.logAudit('login_failed',{identifier,reason,attempts:attempts.count});showToast('Invalid credentials','error')}showApp(){document.getElementById('authContainer').style.display='none';document.getElementById('appContainer').classList.add('active');document.getElementById('userName').textContent=this.currentUser.name;document.getElementById('userRole').textContent=this.currentUser.isManager?'Manager':'Employee';const avatarEl=document.getElementById('userAvatar');if(this.currentUser.photo){avatarEl.innerHTML=`<img src="${this.currentUser.photo}" alt="${this.currentUser.name}">`}else{avatarEl.textContent=this.currentUser.name.charAt(0).toUpperCase()}if(this.currentUser.isManager){document.getElementById('managerVaultTab').style.display='block';document.getElementById('managerArchiveTab').style.display='block';document.getElementById('bulkExportBtn').style.display='block'}if(this.adminMode){document.getElementById('adminTab').style.display='block';showToast('Admin mode activated - Full system access enabled','warning')}this.loadAllContent()}logout(){this.logAudit('logout');this.currentUser=null;this.sessionToken=null;try{localStorage.removeItem('mre_ts_session')}catch(e){}if(this.autoSaveTimeout)clearTimeout(this.autoSaveTimeout);if(this.vaultCheckInterval)clearInterval(this.vaultCheckInterval);location.reload()}saveDatabase(){this.setSecureData('mre_ts_users',this.db.users);this.setSecureData('mre_ts_timesheets',this.db.timesheets);this.setSecureData('mre_ts_audit',this.db.auditLog)}initializePayPeriods(){const now=new Date();const currentYear=now.getFullYear();const startOfYear=new Date(currentYear,0,1);let firstFriday=new Date(startOfYear);while(firstFriday.getDay()!==5){firstFriday.setDate(firstFriday.getDate()+1)}const payPeriods=[];let periodStart=new Date(firstFriday);while(periodStart.getFullYear()===currentYear){const periodEnd=new Date(periodStart);periodEnd.setDate(periodEnd.getDate()+13);payPeriods.push({id:this.formatDateForId(periodStart),startDate:new Date(periodStart),endDate:new Date(periodEnd)});periodStart.setDate(periodStart.getDate()+14)}this.payPeriods=payPeriods}formatDateForId(date){return date.toISOString().split('T')[0]}loadAllContent(){this.loadCurrentTimesheets();this.loadMyVault();this.loadMyArchive();if(this.currentUser.isManager){this.populateEmployeeFilters();this.loadManagerVault();this.loadManagerArchive()}if(this.adminMode){this.loadAdminPanel()}}loadCurrentTimesheets(){const now=new Date();const activePayPeriods=this.payPeriods.filter(p=>p.endDate>=now).slice(0,2);const container=document.getElementById('activeTimesheets');container.innerHTML=activePayPeriods.map(period=>{const timesheet=this.getOrCreateTimesheet(this.currentUser.id,period.id);return this.renderTimesheetCard(timesheet,period,true)}).join('');this.updateEarningsSummary(activePayPeriods)}updateEarningsSummary(periods){const grid=document.getElementById('earningsGrid');let totalRegularEarnings=0;let totalOvertimeEarnings=0;let totalHours=0;let totalOvertimeHours=0;periods.forEach(period=>{const timesheet=this.getOrCreateTimesheet(this.currentUser.id,period.id);const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,this.currentUser);totalRegularEarnings+=earnings.regularEarnings;totalOvertimeEarnings+=earnings.overtimeEarnings;totalHours+=parseFloat(totals.regular);totalOvertimeHours+=parseFloat(totals.overtime)});const earningsDisplay=this.currentUser.isSalaried?'Salaried':`${(totalRegularEarnings+totalOvertimeEarnings).toFixed(2)}`;const rateDisplay=this.currentUser.isSalaried?'Salaried':`${this.currentUser.hourlyRate.toFixed(2)}`;grid.innerHTML=`<div class="earnings-item"><div class="earnings-value">${earningsDisplay}</div><div class="earnings-label">Total Earnings</div></div><div class="earnings-item"><div class="earnings-value">${totalHours.toFixed(1)}h</div><div class="earnings-label">Regular Hours</div></div><div class="earnings-item"><div class="earnings-value">${totalOvertimeHours.toFixed(1)}h</div><div class="earnings-label">Overtime Hours</div></div><div class="earnings-item"><div class="earnings-value">${rateDisplay}</div><div class="earnings-label">Pay Rate</div></div>`}calculateEarnings(totals,user){if(user.isSalaried){return{regularEarnings:0,overtimeEarnings:0,totalEarnings:0,displayText:'Salaried'}}const regularHours=parseFloat(totals.regular)||0;const overtimeHours=parseFloat(totals.overtime)||0;return{regularEarnings:regularHours*user.hourlyRate,overtimeEarnings:overtimeHours*user.overtimeRate,totalEarnings:(regularHours*user.hourlyRate)+(overtimeHours*user.overtimeRate),displayText:null}}loadMyVault(){const myVaultTimesheets=this.db.timesheets.filter(ts=>ts.userId===this.currentUser.id&&ts.status==='vault');this.renderVaultContent('myVaultContent',myVaultTimesheets,'My Vault')}loadMyArchive(){const myArchiveTimesheets=this.db.timesheets.filter(ts=>ts.userId===this.currentUser.id&&ts.status==='archived');this.renderArchiveContent('myArchiveContent',myArchiveTimesheets,'My Archive')}loadManagerVault(){if(!this.currentUser.isManager)return;const selectedUserId=document.getElementById('vaultEmployeeFilter')?.value;let vaultTimesheets=this.db.timesheets.filter(ts=>ts.status==='vault');if(selectedUserId){vaultTimesheets=vaultTimesheets.filter(ts=>ts.userId==selectedUserId)}this.renderVaultContent('managerVaultContent',vaultTimesheets,'Manager Vault')}loadManagerArchive(){if(!this.currentUser.isManager)return;const selectedUserId=document.getElementById('archiveEmployeeFilter')?.value;let archiveTimesheets=this.db.timesheets.filter(ts=>ts.status==='archived');if(selectedUserId){archiveTimesheets=archiveTimesheets.filter(ts=>ts.userId==selectedUserId)}this.renderArchiveContent('managerArchiveContent',archiveTimesheets,'Manager Archive')}renderVaultContent(containerId,timesheets,title){const container=document.getElementById(containerId);if(timesheets.length===0){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">🗄️</div><h3>No Timesheets in Vault</h3><p>Completed timesheets will appear here between 2-4 weeks after completion.</p></div>`;return}const groupedTimesheets=this.groupTimesheetsByMonthYear(timesheets);container.innerHTML=Object.keys(groupedTimesheets).sort((a,b)=>new Date(b)-new Date(a)).map(monthYear=>{const monthTimesheets=groupedTimesheets[monthYear];return this.renderPeriodGroup(monthYear,monthTimesheets,'vault')}).join('')}renderArchiveContent(containerId,timesheets,title){const container=document.getElementById(containerId);if(timesheets.length===0){container.innerHTML=`<div class="empty-state"><div class="empty-state-icon">📦</div><h3>No Timesheets in Archive</h3><p>Historical timesheets will appear here after 4+ weeks.</p></div>`;return}const groupedTimesheets=this.groupTimesheetsByMonthYear(timesheets);container.innerHTML=Object.keys(groupedTimesheets).sort((a,b)=>new Date(b)-new Date(a)).map(monthYear=>{const monthTimesheets=groupedTimesheets[monthYear];return this.renderPeriodGroup(monthYear,monthTimesheets,'archive')}).join('')}groupTimesheetsByMonthYear(timesheets){const grouped={};timesheets.forEach(timesheet=>{const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);if(period){const monthYear=period.endDate.toLocaleDateString('en-US',{year:'numeric',month:'long'});if(!grouped[monthYear]){grouped[monthYear]=[]}grouped[monthYear].push(timesheet)}});return grouped}renderPeriodGroup(monthYear,timesheets,type){const typeLabel=type==='vault'?'Vault':'Archive';const typeClass=type==='vault'?'vault-indicator':'archive-indicator';return`<div class="period-group"><div class="period-header">${monthYear} - ${typeLabel}</div><div class="period-content">${timesheets.map(timesheet=>this.renderTimesheetItem(timesheet,type)).join('')}</div></div>`}renderTimesheetItem(timesheet,type){const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,user);const showEmployeeName=this.currentUser.isManager&&timesheet.userId!==this.currentUser.id;return`<div class="timesheet-item"><div class="timesheet-info">${showEmployeeName?`<div style="font-weight:600;color:var(--primary);">${user?.name} (${user?.employeeId})</div>`:''}<div style="font-weight:600;">${this.formatDate(period.startDate)} - ${this.formatDate(period.endDate)}</div><div style="color:var(--gray);font-size:14px;">${totals.regular}h regular + ${totals.overtime}h overtime = ${(parseFloat(totals.regular)+parseFloat(totals.overtime)).toFixed(2)}h total</div><div style="color:var(--success);font-weight:600;font-size:14px;">${user.isSalaried?'💼 Salaried Employee':`💰 Total Earnings: ${earnings.totalEarnings.toFixed(2)}`}</div><div style="margin-top:8px;"><span class="${type==='vault'?'vault-indicator':'archive-indicator'}">${type==='vault'?'🗄️ In Vault':'📦 Archived'}</span>${timesheet.autoExported?'<span style="margin-left:8px;color:var(--success);font-size:12px;">✅ Auto-exported</span>':''}</div></div><div class="timesheet-actions"><button class="btn btn-primary btn-small" onclick="timesheet.viewTimesheet('${timesheet.id}')">👁️ View</button><button class="btn btn-success btn-small" onclick="timesheet.exportTimesheet('${timesheet.id}')">📥 Export ADP</button><button class="btn btn-secondary btn-small" onclick="timesheet.emailTimesheet('${timesheet.id}')">📧 Email</button><button class="btn btn-info btn-small" onclick="timesheet.printTimesheet('${timesheet.id}')">🖨️ Print</button></div></div>`}populateEmployeeFilters(){const employees=this.db.users.filter(u=>!u.isManager||u.id===this.currentUser.id);const vaultFilter=document.getElementById('vaultEmployeeFilter');if(vaultFilter){vaultFilter.innerHTML='<option value="">All Employees</option>'+employees.map(user=>`<option value="${user.id}">${user.name}</option>`).join('')}const archiveFilter=document.getElementById('archiveEmployeeFilter');if(archiveFilter){archiveFilter.innerHTML='<option value="">All Employees</option>'+employees.map(user=>`<option value="${user.id}">${user.name}</option>`).join('')}}filterManagerVault(){this.loadManagerVault()}filterManagerArchive(){this.loadManagerArchive()}getOrCreateTimesheet(userId,payPeriodId){let timesheet=this.db.timesheets.find(ts=>ts.userId===userId&&ts.payPeriodId===payPeriodId);if(!timesheet){timesheet={id:`${userId}_${payPeriodId}`,userId,payPeriodId,entries:this.createEmptyEntries(),timeOff:this.createEmptyTimeOff(),createdAt:new Date().toISOString(),lastModified:new Date().toISOString(),status:'active',exported:false,autoExported:false};this.db.timesheets.push(timesheet);this.saveDatabase()}if(!timesheet.timeOff){timesheet.timeOff=this.createEmptyTimeOff();this.saveDatabase()}return timesheet}createEmptyEntries(){const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];const entries={};for(let week=1;week<=2;week++){days.forEach(day=>{const key=`week${week}_${day.toLowerCase()}`;entries[key]={hours:'',overtime:'',notes:''}})}return entries}createEmptyTimeOff(){return{sick:{used:false,hours:0},unpaid:{used:false,hours:0},vacation:{used:false,hours:0}}}renderTimesheetCard(timesheet,period,editable=false){const user=this.db.users.find(u=>u.id===timesheet.userId);const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,user);const weeklyHours=parseFloat(totals.week1Regular)+parseFloat(totals.week2Regular);const overtimeWarning=weeklyHours>40?`<div class="overtime-warning">⚠️ Warning: ${weeklyHours.toFixed(1)} hours exceeds 40-hour threshold</div>`:'';return`<div class="card" data-timesheet-id="${timesheet.id}"><div class="card-header"><div><h3 class="card-title">${user?.name||'Unknown'}</h3><p style="color:var(--gray);font-size:14px;">${this.formatDate(period.startDate)} - ${this.formatDate(period.endDate)}</p></div><div style="text-align:right;"><div class="status-badge status-active">Active</div><div style="margin-top:8px;font-weight:600;">${totals.regular}h regular / ${totals.overtime}h OT</div><div style="color:var(--success);font-weight:600;font-size:16px;">${user.isSalaried?'💼 Salaried Employee':`💰 ${earnings.totalEarnings.toFixed(2)}`}</div></div></div><div class="card-body">${this.renderTimesheetTable(timesheet,period,editable)}${this.renderTimeOffSection(timesheet,editable)}${overtimeWarning}${editable?`<div class="export-buttons"><button class="btn btn-primary" onclick="timesheet.exportTimesheet('${timesheet.id}')">📥 Download ADP Format</button><button class="btn btn-success" onclick="timesheet.emailTimesheet('${timesheet.id}')">📧 Email Timesheet</button><button class="btn btn-info" onclick="timesheet.printTimesheet('${timesheet.id}')">🖨️ Print</button><button class="btn btn-warning" onclick="timesheet.exportTimeOffWorksheet('${timesheet.id}')">🏖️ Export Time Off</button></div>`:''}</div></div>`}renderTimesheetTable(timesheet,period,editable=false){const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];const user=this.db.users.find(u=>u.id===timesheet.userId);let table=`<table class="timesheet-table"><thead><tr><th>Day</th><th>Week 1 Hours</th><th>Week 1 OT</th><th>Week 2 Hours</th><th>Week 2 OT</th><th>Notes</th></tr></thead><tbody>`;days.forEach(day=>{const week1Key=`week1_${day.toLowerCase()}`;const week2Key=`week2_${day.toLowerCase()}`;const week1Entry=timesheet.entries[week1Key]||{hours:'',overtime:'',notes:''};const week2Entry=timesheet.entries[week2Key]||{hours:'',overtime:'',notes:''};table+=`<tr><td><strong>${day}</strong></td><td><input type="number" step="0.25" min="0" max="24" value="${week1Entry.hours}" ${editable?`onchange="timesheet.updateEntry('${timesheet.id}','${week1Key}','hours',this.value)"`:'readonly'}></td><td><input type="number" step="0.25" min="0" max="24" value="${week1Entry.overtime}" ${editable?`onchange="timesheet.updateEntry('${timesheet.id}','${week1Key}','overtime',this.value)"`:'readonly'}></td><td><input type="number" step="0.25" min="0" max="24" value="${week2Entry.hours}" ${editable?`onchange="timesheet.updateEntry('${timesheet.id}','${week2Key}','hours',this.value)"`:'readonly'}></td><td><input type="number" step="0.25" min="0" max="24" value="${week2Entry.overtime}" ${editable?`onchange="timesheet.updateEntry('${timesheet.id}','${week2Key}','overtime',this.value)"`:'readonly'}></td><td><input type="text" value="${week1Entry.notes||''}" ${editable?`onchange="timesheet.updateEntry('${timesheet.id}','${week1Key}','notes',this.value)"`:'readonly'} placeholder="Notes for week"></td></tr>`});const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,user);table+=`<tr class="total-row"><td><strong>TOTALS</strong></td><td><strong>${totals.week1Regular}h</strong></td><td><strong>${totals.week1Overtime}h</strong></td><td><strong>${totals.week2Regular}h</strong></td><td><strong>${totals.week2Overtime}h</strong></td><td><strong>${(parseFloat(totals.regular)+parseFloat(totals.overtime)).toFixed(2)}h total</strong></td></tr><tr class="earnings-highlight"><td><strong>EARNINGS</strong></td><td><strong>${user.isSalaried?'Salaried':`${(parseFloat(totals.week1Regular)*user.hourlyRate).toFixed(2)}`}</strong></td><td><strong>${user.isSalaried?'Salaried':`${(parseFloat(totals.week1Overtime)*user.overtimeRate).toFixed(2)}`}</strong></td><td><strong>${user.isSalaried?'Salaried':`${(parseFloat(totals.week2Regular)*user.hourlyRate).toFixed(2)}`}</strong></td><td><strong>${user.isSalaried?'Salaried':`${(parseFloat(totals.week2Overtime)*user.overtimeRate).toFixed(2)}`}</strong></td><td><strong>${user.isSalaried?'💼 SALARIED EMPLOYEE':`💰 ${earnings.totalEarnings.toFixed(2)} TOTAL`}</strong></td></tr></tbody></table>`;return table}renderTimeOffSection(timesheet,editable){if(!editable)return'';const timeOff=timesheet.timeOff||this.createEmptyTimeOff();return`<div class="time-off-section"><div class="time-off-header">🏖️ Time Off Request (Pay Period)</div><div class="time-off-options"><div class="time-off-option"><div class="time-off-checkbox"><input type="checkbox" id="sick_${timesheet.id}" ${timeOff.sick.used?'checked':''} onchange="timesheet.toggleTimeOff('${timesheet.id}','sick',this.checked)"><label for="sick_${timesheet.id}" style="font-weight:600;">Sick Leave</label></div><div class="time-off-hours ${timeOff.sick.used?'visible':''}" id="sick_hours_${timesheet.id}"><select onchange="timesheet.updateTimeOffHours('${timesheet.id}','sick',this.value)"><option value="0">Select hours...</option>${this.generateHourOptions(timeOff.sick.hours)}</select></div></div><div class="time-off-option"><div class="time-off-checkbox"><input type="checkbox" id="unpaid_${timesheet.id}" ${timeOff.unpaid.used?'checked':''} onchange="timesheet.toggleTimeOff('${timesheet.id}','unpaid',this.checked)"><label for="unpaid_${timesheet.id}" style="font-weight:600;">Unpaid Leave</label></div><div class="time-off-hours ${timeOff.unpaid.used?'visible':''}" id="unpaid_hours_${timesheet.id}"><select onchange="timesheet.updateTimeOffHours('${timesheet.id}','unpaid',this.value)"><option value="0">Select hours...</option>${this.generateHourOptions(timeOff.unpaid.hours)}</select></div></div><div class="time-off-option"><div class="time-off-checkbox"><input type="checkbox" id="vacation_${timesheet.id}" ${timeOff.vacation.used?'checked':''} onchange="timesheet.toggleTimeOff('${timesheet.id}','vacation',this.checked)"><label for="vacation_${timesheet.id}" style="font-weight:600;">Vacation</label></div><div class="time-off-hours ${timeOff.vacation.used?'visible':''}" id="vacation_hours_${timesheet.id}"><select onchange="timesheet.updateTimeOffHours('${timesheet.id}','vacation',this.value)"><option value="0">Select hours...</option>${this.generateHourOptions(timeOff.vacation.hours)}</select></div></div></div></div>`}generateHourOptions(selectedHours){let options='';for(let i=0.5;i<=8;i+=0.5){const selected=i===selectedHours?'selected':'';options+=`<option value="${i}" ${selected}>${i} hours</option>`}return options}toggleTimeOff(timesheetId,type,checked){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);if(!timesheet)return;if(!timesheet.timeOff){timesheet.timeOff=this.createEmptyTimeOff()}timesheet.timeOff[type].used=checked;if(!checked){timesheet.timeOff[type].hours=0}timesheet.lastModified=new Date().toISOString();this.saveDatabase();const hoursDiv=document.getElementById(`${type}_hours_${timesheetId}`);if(hoursDiv){hoursDiv.classList.toggle('visible',checked)}this.logAudit('timeoff_toggled',{timesheetId,type,checked})}updateTimeOffHours(timesheetId,type,hours){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);if(!timesheet)return;if(!timesheet.timeOff){timesheet.timeOff=this.createEmptyTimeOff()}timesheet.timeOff[type].hours=parseFloat(hours);timesheet.lastModified=new Date().toISOString();this.saveDatabase();this.logAudit('timeoff_hours_updated',{timesheetId,type,hours});if(hours>0){showToast(`${type.charAt(0).toUpperCase()+type.slice(1)} time updated: ${hours} hours`,'success')}}exportTimeOffWorksheet(timesheetId){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);const worksheetData=this.generateADPTimeOffWorksheet(timesheet,user,period);const blob=new Blob([worksheetData],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`${user.name.replace(/\s+/g,'_')}_TimeOff_${period.id}.csv`;a.click();URL.revokeObjectURL(url);this.logAudit('timeoff_worksheet_exported',{timesheetId});showToast('Time Off worksheet exported successfully','success')}generateADPTimeOffWorksheet(timesheet,user,period){const timeOff=timesheet.timeOff||this.createEmptyTimeOff();let csv='ADP WorkforceNow Time Off Worksheet\n';csv+='File Version,2.0\n';csv+='Export Date,'+new Date().toISOString().split('T')[0]+'\n';csv+='Pay Period,'+this.formatADPDate(period.startDate)+' to '+this.formatADPDate(period.endDate)+'\n\n';csv+='Employee ID,Employee Name,Time Off Type,Hours Requested,Date Range,Status,Approval Required\n';Object.keys(timeOff).forEach(type=>{if(timeOff[type].used&&timeOff[type].hours>0){const typeMapping={sick:'Sick Leave',unpaid:'Unpaid Leave',vacation:'Vacation'};csv+=`${user.employeeId},"${user.name}","${typeMapping[type]}",${timeOff[type].hours},"${this.formatADPDate(period.startDate)} to ${this.formatADPDate(period.endDate)}",Pending,Yes\n`}});if(!Object.values(timeOff).some(t=>t.used&&t.hours>0)){csv+=`${user.employeeId},"${user.name}","No Time Off",0,"${this.formatADPDate(period.startDate)} to ${this.formatADPDate(period.endDate)}",N/A,No\n`}csv+='\nADP PROCESSING NOTES\n';csv+='Worksheet Type,Time Off Request\n';csv+='Ready for Processing,YES\n';csv+='Manager Approval Required,YES\n';csv+='Auto-Deduct from Balances,NO\n';return csv}updateEntry(timesheetId,entryKey,field,value){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);if(!timesheet)return;if(!timesheet.entries[entryKey]){timesheet.entries[entryKey]={hours:'',overtime:'',notes:''}}timesheet.entries[entryKey][field]=value;timesheet.lastModified=new Date().toISOString();this.saveDatabase();this.logAudit('timesheet_updated',{timesheetId,entryKey,field,value});this.updateTimesheetTotals(timesheetId);this.updateEarningsSummary(this.payPeriods.filter(p=>p.endDate>=new Date()).slice(0,2))}updateTimesheetTotals(timesheetId){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);if(!timesheet)return;const user=this.db.users.find(u=>u.id===timesheet.userId);const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,user);const table=document.querySelector(`[data-timesheet-id="${timesheetId}"] .timesheet-table`);if(table){const totalRow=table.querySelector('.total-row');const earningsRow=table.querySelector('.earnings-highlight');if(totalRow){const cells=totalRow.querySelectorAll('td');if(cells.length>=6){cells[1].innerHTML=`<strong>${totals.week1Regular}h</strong>`;cells[2].innerHTML=`<strong>${totals.week1Overtime}h</strong>`;cells[3].innerHTML=`<strong>${totals.week2Regular}h</strong>`;cells[4].innerHTML=`<strong>${totals.week2Overtime}h</strong>`;cells[5].innerHTML=`<strong>${(parseFloat(totals.regular)+parseFloat(totals.overtime)).toFixed(2)}h total</strong>`}}if(earningsRow){const cells=earningsRow.querySelectorAll('td');if(cells.length>=6){cells[1].innerHTML=`<strong>${(parseFloat(totals.week1Regular)*user.hourlyRate).toFixed(2)}</strong>`;cells[2].innerHTML=`<strong>${(parseFloat(totals.week1Overtime)*user.overtimeRate).toFixed(2)}</strong>`;cells[3].innerHTML=`<strong>${(parseFloat(totals.week2Regular)*user.hourlyRate).toFixed(2)}</strong>`;cells[4].innerHTML=`<strong>${(parseFloat(totals.week2Overtime)*user.overtimeRate).toFixed(2)}</strong>`;cells[5].innerHTML=`<strong>💰 ${earnings.totalEarnings.toFixed(2)} TOTAL</strong>`}}}const cardHeader=document.querySelector(`[data-timesheet-id="${timesheetId}"] .card-header`);if(cardHeader){const hoursDisplay=cardHeader.querySelector('[style*="font-weight: 600"]');const earningsDisplay=cardHeader.querySelector('[style*="color: var(--success)"]');if(hoursDisplay){hoursDisplay.textContent=`${totals.regular}h regular / ${totals.overtime}h OT`}if(earningsDisplay){earningsDisplay.textContent=`💰 ${earnings.totalEarnings.toFixed(2)}`}}}calculateTotalHours(timesheet){let week1Regular=0,week1Overtime=0;let week2Regular=0,week2Overtime=0;Object.keys(timesheet.entries).forEach(key=>{const entry=timesheet.entries[key];const hours=parseFloat(entry.hours)||0;const overtime=parseFloat(entry.overtime)||0;if(key.startsWith('week1_')){week1Regular+=hours;week1Overtime+=overtime}else if(key.startsWith('week2_')){week2Regular+=hours;week2Overtime+=overtime}});return{week1Regular:week1Regular.toFixed(2),week1Overtime:week1Overtime.toFixed(2),week2Regular:week2Regular.toFixed(2),week2Overtime:week2Overtime.toFixed(2),regular:(week1Regular+week2Regular).toFixed(2),overtime:(week1Overtime+week2Overtime).toFixed(2)}}formatDate(date){return new Intl.DateFormat('en-US',{month:'short',day:'numeric',year:'numeric'}).format(date)}exportTimesheet(timesheetId){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);const adpData=this.generateADPFormat(timesheet,user,period);const blob=new Blob([adpData],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`${user.name.replace(/\s+/g,'_')}_timesheet_${period.id}.csv`;a.click();URL.revokeObjectURL(url);timesheet.manuallyExported=true;timesheet.lastExportedAt=new Date().toISOString();this.saveDatabase();this.logAudit('timesheet_exported',{timesheetId,format:'ADP',manual:true});showToast('Timesheet exported successfully','success')}generateADPFormat(timesheet,user,period){const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,user);let csv='File Format,ADP Payroll Export v2.0\n';csv+='Export Date,'+new Date().toISOString().split('T')[0]+'\n';csv+='Pay Period,'+this.formatADPDate(period.startDate)+' to '+this.formatADPDate(period.endDate)+'\n\n';csv+='EMPLOYEE SUMMARY\n';csv+='Employee ID,Employee Name,Department,Pay Rate,OT Rate,Regular Hours,Overtime Hours,Regular Earnings,Overtime Earnings,Total Earnings\n';csv+=`${user.employeeId},"${user.name}",General,${user.hourlyRate.toFixed(2)},${user.overtimeRate.toFixed(2)},${totals.regular},${totals.overtime},${earnings.regularEarnings.toFixed(2)},${earnings.overtimeEarnings.toFixed(2)},${earnings.totalEarnings.toFixed(2)}\n\n`;csv+='WEEKLY BREAKDOWN\n';csv+='Week,Regular Hours,Overtime Hours,Total Hours,Regular Earnings,Overtime Earnings,Total Earnings\n';csv+=`Week 1,${totals.week1Regular},${totals.week1Overtime},${(parseFloat(totals.week1Regular)+parseFloat(totals.week1Overtime)).toFixed(2)},${(parseFloat(totals.week1Regular)*user.hourlyRate).toFixed(2)},${(parseFloat(totals.week1Overtime)*user.overtimeRate).toFixed(2)},${((parseFloat(totals.week1Regular)*user.hourlyRate)+(parseFloat(totals.week1Overtime)*user.overtimeRate)).toFixed(2)}\n`;csv+=`Week 2,${totals.week2Regular},${totals.week2Overtime},${(parseFloat(totals.week2Regular)+parseFloat(totals.week2Overtime)).toFixed(2)},${(parseFloat(totals.week2Regular)*user.hourlyRate).toFixed(2)},${(parseFloat(totals.week2Overtime)*user.overtimeRate).toFixed(2)},${((parseFloat(totals.week2Regular)*user.hourlyRate)+(parseFloat(totals.week2Overtime)*user.overtimeRate)).toFixed(2)}\n\n`;csv+='DAILY BREAKDOWN\n';csv+='Date,Day of Week,Regular Hours,Overtime Hours,Daily Earnings,Notes\n';const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];const startDate=new Date(period.startDate);for(let week=1;week<=2;week++){days.forEach((day,dayIndex)=>{const entryKey=`week${week}_${day.toLowerCase()}`;const entry=timesheet.entries[entryKey]||{hours:'0',overtime:'0',notes:''};const dateOffset=((week-1)*7)+dayIndex;const currentDate=new Date(startDate.getTime()+(dateOffset*24*60*60*1000));const regularHours=parseFloat(entry.hours)||0;const overtimeHours=parseFloat(entry.overtime)||0;const dailyEarnings=(regularHours*user.hourlyRate)+(overtimeHours*user.overtimeRate);csv+=`${this.formatADPDate(currentDate)},${day},${entry.hours||'0'},${entry.overtime||'0'},${dailyEarnings.toFixed(2)},"${entry.notes||''}"\n`})}csv+='\nADP PROCESSING NOTES\n';csv+='File Generated,MRE Timesheet System\n';csv+='Ready for Import,YES\n';csv+='Verification Required,NO\n';csv+='Auto-Calculate Totals,YES\n';return csv}formatADPDate(date){return date.toISOString().split('T')[0]}emailTimesheet(timesheetId){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,user);const emailContent={to:'payroll@mrelectric.com',subject:`Timesheet - ${user.name} - ${this.formatDate(period.startDate)} to ${this.formatDate(period.endDate)}`,body:`PAYROLL READY TIMESHEET\n\nEmployee: ${user.name} (${user.employeeId})\nPay Period: ${this.formatDate(period.startDate)} - ${this.formatDate(period.endDate)}\n\nSUMMARY:\nRegular Hours: ${totals.regular}\nOvertime Hours: ${totals.overtime}\nTotal Hours: ${(parseFloat(totals.regular)+parseFloat(totals.overtime)).toFixed(2)}\n\nEARNINGS:\nRegular Earnings: ${earnings.regularEarnings.toFixed(2)} (${totals.regular}h × ${user.hourlyRate.toFixed(2)})\nOvertime Earnings: ${earnings.overtimeEarnings.toFixed(2)} (${totals.overtime}h × ${user.overtimeRate.toFixed(2)})\nTotal Earnings: ${earnings.totalEarnings.toFixed(2)}\n\nThe attached ADP-formatted CSV file is ready for direct import into ADP.\nNo additional processing required.`,attachment:this.generateADPFormat(timesheet,user,period)};console.log('Email sent to payroll:',emailContent);this.logAudit('timesheet_emailed',{timesheetId});showToast('Timesheet emailed to payroll','success')}printTimesheet(timesheetId){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);const printWindow=window.open('','_blank');printWindow.document.write(`<html><head><title>Timesheet - ${user.name}</title><style>body{font-family:Arial,sans-serif;margin:20px}.header{text-align:center;margin-bottom:30px}table{width:100%;border-collapse:collapse;margin-bottom:20px}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background-color:#f2f2f2}.total-row{font-weight:bold;background-color:#f9f9f9}.earnings-row{font-weight:bold;background-color:#e8f5e8;color:#2d5a2d}@media print{button{display:none}}</style></head><body><div class="header"><h1>MRE Electric - Timesheet</h1><h2>${user.name} (${user.employeeId})</h2><p>Pay Period: ${this.formatDate(period.startDate)} - ${this.formatDate(period.endDate)}</p></div>${this.renderTimesheetTable(timesheet,period,false)}<button onclick="window.print()">Print This Timesheet</button></body></html>`);printWindow.document.close();printWindow.focus();this.logAudit('timesheet_printed',{timesheetId})}viewTimesheet(timesheetId){const timesheet=this.db.timesheets.find(ts=>ts.id===timesheetId);const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);const earnings=this.calculateEarnings(this.calculateTotalHours(timesheet),user);const modalBody=`<div style="margin-bottom:20px;"><h4>${user.name} (${user.employeeId})</h4><p style="color:var(--gray);">${this.formatDate(period.startDate)} - ${this.formatDate(period.endDate)}</p><div style="margin-top:8px;"><span class="status-badge status-${timesheet.status}">${timesheet.status}</span>${timesheet.autoExported?'<span style="margin-left:8px;color:var(--success);font-size:12px;">✅ Auto-exported</span>':''}${timesheet.manuallyExported?'<span style="margin-left:8px;color:var(--primary);font-size:12px;">📥 Manually exported</span>':''}</div><div style="margin-top:12px;padding:12px;background:#f0f9ff;border-radius:8px;"><strong>Total Earnings: ${earnings.totalEarnings.toFixed(2)}</strong><br><small>Regular: ${earnings.regularEarnings.toFixed(2)} | Overtime: ${earnings.overtimeEarnings.toFixed(2)}</small></div></div>${this.renderTimesheetTable(timesheet,period,false)}`;const modalFooter=`<button class="btn btn-secondary" onclick="closeModal()">Close</button><button class="btn btn-primary" onclick="timesheet.exportTimesheet('${timesheetId}');closeModal();">Export ADP</button><button class="btn btn-success" onclick="timesheet.emailTimesheet('${timesheetId}');closeModal();">Email</button><button class="btn btn-info" onclick="timesheet.printTimesheet('${timesheetId}');closeModal();">Print</button>`;showModal('Timesheet Details',modalBody,modalFooter)}quickTimeEntry(){const modalBody=`<form id="quickEntryForm" onsubmit="timesheet.submitQuickEntry(event)"><div class="form-group"><label class="form-label">Which week?</label><select id="quickWeek" class="form-control" required><option value="week1">Week 1</option><option value="week2">Week 2</option></select></div><div class="form-group"><label class="form-label">Day of week</label><select id="quickDay" class="form-control" required><option value="monday">Monday</option><option value="tuesday">Tuesday</option><option value="wednesday">Wednesday</option><option value="thursday">Thursday</option><option value="friday">Friday</option><option value="saturday">Saturday</option><option value="sunday">Sunday</option></select></div><div class="form-group"><label class="form-label">Regular Hours</label><input type="number" id="quickRegular" class="form-control" step="0.25" min="0" max="24" placeholder="8"></div><div class="form-group"><label class="form-label">Overtime Hours</label><input type="number" id="quickOvertime" class="form-control" step="0.25" min="0" max="24" placeholder="0"></div><div class="form-group"><label class="form-label">Notes (optional)</label><input type="text" id="quickNotes" class="form-control" placeholder="Any notes for this day"></div></form>`;const modalFooter=`<button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="document.getElementById('quickEntryForm').dispatchEvent(new Event('submit'))">Add Entry</button>`;showModal('Quick Time Entry',modalBody,modalFooter)}submitQuickEntry(event){event.preventDefault();const week=document.getElementById('quickWeek').value;const day=document.getElementById('quickDay').value;const regular=document.getElementById('quickRegular').value;const overtime=document.getElementById('quickOvertime').value;const notes=document.getElementById('quickNotes').value;const now=new Date();const activePayPeriods=this.payPeriods.filter(p=>p.endDate>=now).slice(0,2);const currentPeriod=activePayPeriods[0];if(currentPeriod){const timesheet=this.getOrCreateTimesheet(this.currentUser.id,currentPeriod.id);const entryKey=`${week}_${day}`;this.updateEntry(timesheet.id,entryKey,'hours',regular);this.updateEntry(timesheet.id,entryKey,'overtime',overtime);this.updateEntry(timesheet.id,entryKey,'notes',notes);closeModal();showToast('Quick entry added successfully!','success');this.loadCurrentTimesheets()}else{showToast('No active pay period found','error')}}copyLastWeek(){const now=new Date();const activePayPeriods=this.payPeriods.filter(p=>p.endDate>=now).slice(0,2);const currentPeriod=activePayPeriods[0];if(!currentPeriod){showToast('No active pay period found','error');return}const timesheet=this.getOrCreateTimesheet(this.currentUser.id,currentPeriod.id);const days=['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];days.forEach(day=>{const week1Entry=timesheet.entries[`week1_${day}`];if(week1Entry&&(week1Entry.hours||week1Entry.overtime)){this.updateEntry(timesheet.id,`week2_${day}`,'hours',week1Entry.hours);this.updateEntry(timesheet.id,`week2_${day}`,'overtime',week1Entry.overtime);this.updateEntry(timesheet.id,`week2_${day}`,'notes',week1Entry.notes)}});showToast('Week 1 copied to Week 2!','success');this.loadCurrentTimesheets()}bulkExport(){const activeTimesheets=this.db.timesheets.filter(ts=>ts.status==='active');if(activeTimesheets.length===0){showToast('No active timesheets to export','warning');return}let bulkData='MRE ELECTRIC BULK TIMESHEET EXPORT\n';bulkData+='Generated: '+new Date().toLocaleString()+'\n\n';activeTimesheets.forEach(timesheet=>{const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);bulkData+='='.repeat(50)+'\n';bulkData+=this.generateADPFormat(timesheet,user,period);bulkData+='\n\n'});const blob=new Blob([bulkData],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`MRE_Bulk_Export_${new Date().toISOString().split('T')[0]}.txt`;a.click();URL.revokeObjectURL(url);showToast('Bulk export completed!','success')}bulkEmailAll(type){const timesheets=this.db.timesheets.filter(ts=>ts.status===type);if(timesheets.length===0){showToast(`No ${type} timesheets to email`,'warning');return}console.log(`Bulk emailing ${timesheets.length} ${type} timesheets to payroll`);timesheets.forEach(timesheet=>{this.emailTimesheet(timesheet.id)});showToast(`${timesheets.length} ${type} timesheets emailed to payroll`,'success')}bulkExportAll(type){const timesheets=this.db.timesheets.filter(ts=>ts.status===type);if(timesheets.length===0){showToast(`No ${type} timesheets to export`,'warning');return}let bulkData=`MRE ELECTRIC ${type.toUpperCase()} BULK EXPORT\n`;bulkData+='Generated: '+new Date().toLocaleString()+'\n\n';timesheets.forEach(timesheet=>{const user=this.db.users.find(u=>u.id===timesheet.userId);const period=this.payPeriods.find(p=>p.id===timesheet.payPeriodId);bulkData+='='.repeat(50)+'\n';bulkData+=this.generateADPFormat(timesheet,user,period);bulkData+='\n\n'});const blob=new Blob([bulkData],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`MRE_${type}_Bulk_Export_${new Date().toISOString().split('T')[0]}.txt`;a.click();URL.revokeObjectURL(url);showToast(`Bulk ${type} export completed!`,'success')}generatePayrollReport(){const archiveTimesheets=this.db.timesheets.filter(ts=>ts.status==='archived');if(archiveTimesheets.length===0){showToast('No archived timesheets for report','warning');return}let report='MRE ELECTRIC COMPREHENSIVE PAYROLL REPORT\n';report+='Generated: '+new Date().toLocaleString()+'\n';report+='='.repeat(60)+'\n\n';const employeeSummary={};archiveTimesheets.forEach(timesheet=>{const user=this.db.users.find(u=>u.id===timesheet.userId);const totals=this.calculateTotalHours(timesheet);const earnings=this.calculateEarnings(totals,user);if(!employeeSummary[user.id]){employeeSummary[user.id]={name:user.name,employeeId:user.employeeId,totalHours:0,totalRegularHours:0,totalOvertimeHours:0,totalEarnings:0,periods:0}}employeeSummary[user.id].totalRegularHours+=parseFloat(totals.regular);employeeSummary[user.id].totalOvertimeHours+=parseFloat(totals.overtime);employeeSummary[user.id].totalHours+=parseFloat(totals.regular)+parseFloat(totals.overtime);employeeSummary[user.id].totalEarnings+=earnings.totalEarnings;employeeSummary[user.id].periods++});report+='EMPLOYEE SUMMARY\n';report+='Employee ID,Name,Total Hours,Regular Hours,OT Hours,Total Earnings,Pay Periods\n';Object.values(employeeSummary).forEach(emp=>{report+=`${emp.employeeId},${emp.name},${emp.totalHours.toFixed(2)},${emp.totalRegularHours.toFixed(2)},${emp.totalOvertimeHours.toFixed(2)},${emp.totalEarnings.toFixed(2)},${emp.periods}\n`});const blob=new Blob([report],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`MRE_Payroll_Report_${new Date().toISOString().split('T')[0]}.csv`;a.click();URL.revokeObjectURL(url);showToast('Payroll report generated!','success')}showProfile(){const modalBody=`<div class="profile-section"><h4>Profile Photo</h4><div class="profile-photo-upload"><div class="profile-photo-preview" id="photoPreview">${this.currentUser.photo?`<img src="${this.currentUser.photo}" alt="Profile Photo">`:this.currentUser.name.charAt(0).toUpperCase()}</div><div><input type="file" id="profilePhotoInput" accept="image/*" style="display:none;" onchange="timesheet.handlePhotoUpload(event)"><button class="btn btn-primary btn-small" onclick="document.getElementById('profilePhotoInput').click()">📷 Change Photo</button>${this.currentUser.photo?`<button class="btn btn-danger btn-small" onclick="timesheet.removePhoto()">🗑️ Remove Photo</button>`:''}</div></div><div class="photo-upload-area" onclick="document.getElementById('profilePhotoInput').click()" ondrop="timesheet.handlePhotoDrop(event)" ondragover="timesheet.handlePhotoDragOver(event)">📷 Click here or drag & drop a photo</div></div><div class="profile-section"><h4>Personal Information</h4><form id="profileForm" onsubmit="timesheet.updateProfile(event)"><div class="form-group"><label class="form-label">Display Name</label><input type="text" id="profileName" class="form-control" value="${this.currentUser.name}" required></div><div class="form-group"><label class="form-label">Email Address</label><input type="email" id="profileEmail" class="form-control" value="${this.currentUser.email}" required></div><div class="form-group"><label class="form-label">Employee ID</label><input type="text" class="form-control" value="${this.currentUser.employeeId}" readonly style="background:var(--light);"><small style="color:var(--gray);">Employee ID cannot be changed</small></div><button type="submit" class="btn btn-primary">💾 Save Changes</button></form></div><div class="profile-section"><h4>Pay Information</h4><div style="padding:16px;background:var(--light);border-radius:8px;"><div style="margin-bottom:8px;"><strong>Hourly Rate:</strong> ${this.currentUser.hourlyRate.toFixed(2)}/hour</div><div style="margin-bottom:8px;"><strong>Overtime Rate:</strong> ${this.currentUser.overtimeRate.toFixed(2)}/hour</div><div><strong>Role:</strong> ${this.currentUser.isManager?'Manager':'Employee'}</div></div></div><div class="profile-section"><h4>Change Password</h4><form id="passwordForm" onsubmit="timesheet.changePassword(event)"><div class="form-group"><label class="form-label">Current Password</label><input type="password" id="currentPassword" class="form-control" required></div><div class="form-group"><label class="form-label">New Password</label><input type="password" id="newPassword" class="form-control" required minlength="8"><small style="color:var(--gray);">Minimum 8 characters</small></div><div class="form-group"><label class="form-label">Confirm New Password</label><input type="password" id="confirmPassword" class="form-control" required minlength="8"></div><button type="submit" class="btn btn-warning">🔑 Change Password</button></form></div><div class="profile-section"><h4>Account Statistics</h4><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;"><div style="text-align:center;padding:12px;background:var(--light);border-radius:8px;"><div style="font-size:20px;font-weight:600;color:var(--primary);">${this.db.timesheets.filter(ts=>ts.userId===this.currentUser.id).length}</div><div style="font-size:12px;color:var(--gray);">Total Timesheets</div></div><div style="text-align:center;padding:12px;background:var(--light);border-radius:8px;"><div style="font-size:20px;font-weight:600;color:var(--success);">${new Date(this.currentUser.createdAt).getFullYear()}</div><div style="font-size:12px;color:var(--gray);">Member Since</div></div></div></div>`;const modalFooter=`<button class="btn btn-secondary" onclick="closeModal()">Close</button>`;showModal('My Profile',modalBody,modalFooter)}handlePhotoUpload(event){const file=event.target.files[0];if(!file)return;if(file.size>5*1024*1024){showToast('Photo must be smaller than 5MB','error');return}if(!file.type.startsWith('image/')){showToast('Please select an image file','error');return}const reader=new FileReader();reader.onload=(e)=>{this.currentUser.photo=e.target.result;this.saveDatabase();document.getElementById('photoPreview').innerHTML=`<img src="${e.target.result}" alt="Profile Photo">`;document.getElementById('userAvatar').innerHTML=`<img src="${e.target.result}" alt="${this.currentUser.name}">`;showToast('Profile photo updated!','success')};reader.readAsDataURL(file)}handlePhotoDrop(event){event.preventDefault();event.stopPropagation();const files=event.dataTransfer.files;if(files.length>0){const fakeEvent={target:{files:[files[0]]}};this.handlePhotoUpload(fakeEvent)}event.target.classList.remove('dragover')}handlePhotoDragOver(event){event.preventDefault();event.target.classList.add('dragover')}removePhoto(){this.currentUser.photo=null;this.saveDatabase();document.getElementById('photoPreview').textContent=this.currentUser.name.charAt(0).toUpperCase();document.getElementById('userAvatar').textContent=this.currentUser.name.charAt(0).toUpperCase();showToast('Profile photo removed','success');this.showProfile()}updateProfile(event){event.preventDefault();const newName=document.getElementById('profileName').value.trim();const newEmail=document.getElementById('profileEmail').value.trim();if(!newName||!newEmail){showToast('Please fill in all fields','error');return}const existingUser=this.db.users.find(u=>u.id!==this.currentUser.id&&u.email.toLowerCase()===newEmail.toLowerCase());if(existingUser){showToast('This email is already taken','error');return}this.currentUser.name=newName;this.currentUser.email=newEmail;this.saveDatabase();document.getElementById('userName').textContent=newName;if(!this.currentUser.photo){document.getElementById('userAvatar').textContent=newName.charAt(0).toUpperCase()}this.logAudit('profile_updated',{newName,newEmail});showToast('Profile updated successfully!','success')}async changePassword(event){event.preventDefault();const currentPass=document.getElementById('currentPassword').value;const newPass=document.getElementById('newPassword').value;const confirmPass=document.getElementById('confirmPassword').value;if(newPass!==confirmPass){showToast('New passwords do not match','error');return}if(newPass.length<8){showToast('Password must be at least 8 characters','error');return}const hashedCurrent=await this.hashPassword(currentPass);if(hashedCurrent!==this.currentUser.password){showToast('Current password is incorrect','error');return}this.currentUser.password=await this.hashPassword(newPass);this.saveDatabase();document.getElementById('passwordForm').reset();this.logAudit('password_changed');showToast('Password changed successfully!','success')}loadAdminPanel(){if(!this.adminMode)return;this.loadUserManagement();this.loadSystemStats()}loadUserManagement(){const container=document.getElementById('userManagement');container.innerHTML=`<div class="admin-warning">⚠️ Admin Mode Active - Changes affect all users immediately</div><table class="timesheet-table"><thead><tr><th>Employee ID</th><th>Name</th><th>Email</th><th>Role</th><th>Pay Type</th><th>Hourly Rate</th><th>Actions</th></tr></thead><tbody>${this.db.users.map(user=>`<tr><td>${user.employeeId}</td><td><input type="text" value="${user.name}" onchange="timesheet.updateUserField(${user.id},'name',this.value)" style="border:none;background:transparent;width:100%;"></td><td><input type="email" value="${user.email}" onchange="timesheet.updateUserField(${user.id},'email',this.value)" style="border:none;background:transparent;width:100%;"></td><td><select onchange="timesheet.updateUserField(${user.id},'isManager',this.value==='true')" style="border:none;background:transparent;"><option value="false" ${!user.isManager?'selected':''}>Employee</option><option value="true" ${user.isManager?'selected':''}>Manager</option></select></td><td><select onchange="timesheet.updateUserField(${user.id},'isSalaried',this.value==='true')" style="border:none;background:transparent;"><option value="false" ${!user.isSalaried?'selected':''}>Hourly</option><option value="true" ${user.isSalaried?'selected':''}>Salaried</option></select></td><td>${user.isSalaried?'N/A':`<input type="number" value="${user.hourlyRate}" step="0.01" min="0" onchange="timesheet.updateUserField(${user.id},'hourlyRate',parseFloat(this.value))" style="border:none;background:transparent;width:80px;">`}</td><td><button class="btn btn-danger btn-small" onclick="timesheet.resetUserPassword(${user.id})">🔑 Reset Password</button></td></tr>`).join('')}</tbody></table>`}loadSystemStats(){const container=document.getElementById('systemStats');const totalUsers=this.db.users.length;const totalTimesheets=this.db.timesheets.length;const totalAuditEntries=this.db.auditLog.length;const storageSize=JSON.stringify(this.db).length;container.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;"><div style="text-align:center;padding:16px;background:var(--light);border-radius:8px;"><div style="font-size:24px;font-weight:700;color:var(--primary);">${totalUsers}</div><div style="font-size:12px;color:var(--gray);">Total Users</div></div><div style="text-align:center;padding:16px;background:var(--light);border-radius:8px;"><div style="font-size:24px;font-weight:700;color:var(--success);">${totalTimesheets}</div><div style="font-size:12px;color:var(--gray);">Total Timesheets</div></div><div style="text-align:center;padding:16px;background:var(--light);border-radius:8px;"><div style="font-size:24px;font-weight:700;color:var(--info);">${totalAuditEntries}</div><div style="font-size:12px;color:var(--gray);">Audit Entries</div></div><div style="text-align:center;padding:16px;background:var(--light);border-radius:8px;"><div style="font-size:24px;font-weight:700;color:var(--warning);">${(storageSize/1024).toFixed(1)}KB</div><div style="font-size:12px;color:var(--gray);">Data Size</div></div></div>`}updateUserField(userId,field,value){if(!this.adminMode)return;const user=this.db.users.find(u=>u.id===userId);if(!user)return;user[field]=value;if(field==='isSalaried'){if(value){user.hourlyRate=0.00;user.overtimeRate=0.00}else{user.hourlyRate=15.00;user.overtimeRate=22.50}}if(field==='hourlyRate'&&!user.isSalaried){user.overtimeRate=value*1.5}this.saveDatabase();this.logAudit('admin_user_updated',{userId,field,value});showToast(`${user.name}'s ${field} updated`,'success');this.loadUserManagement()}async resetUserPassword(userId){if(!this.adminMode)return;const user=this.db.users.find(u=>u.id===userId);if(!user)return;if(!confirm(`Reset password for ${user.name}? They will need to use the default password.`)){return}user.password=await this.hashPassword('SecurePass123!');this.saveDatabase();this.logAudit('admin_password_reset',{userId});showToast(`Password reset for ${user.name}. Default: SecurePass123!`,'warning')}openCodeEditor(){if(!this.adminMode)return;document.getElementById('codeEditorModal').style.display='flex';this.currentEditingFile=null}closeCodeEditor(){document.getElementById('codeEditorModal').style.display='none';this.currentEditingFile=null}loadFile(fileType){if(!this.adminMode)return;const editor=document.getElementById('codeEditor');const currentFile=document.getElementById('currentFile');document.querySelectorAll('.file-item').forEach(item=>{item.classList.remove('active')});event.target.classList.add('active');this.currentEditingFile=fileType;switch(fileType){case 'html':currentFile.textContent='📄 HTML Structure (Read-Only View)';editor.value='HTML structure is embedded in the application.\nTo modify layout, contact the developer.';editor.readOnly=true;break;case 'css':currentFile.textContent='🎨 CSS Styles';editor.value=this.extractCSSFromDocument();editor.readOnly=false;break;case 'js':currentFile.textContent='⚙️ JavaScript Logic (Limited Editing)';editor.value='JavaScript functions are compiled.\nUse system controls for safe modifications.';editor.readOnly=true;break;case 'users':currentFile.textContent='👥 User Data';editor.value=JSON.stringify(this.db.users,null,2);editor.readOnly=false;break;case 'timesheets':currentFile.textContent='📋 Timesheet Data';editor.value=JSON.stringify(this.db.timesheets,null,2);editor.readOnly=false;break}}extractCSSFromDocument(){const styleSheets=document.styleSheets;let cssText='/* Current CSS Styles */\n\n';for(let sheet of styleSheets){try{for(let rule of sheet.cssRules){cssText+=rule.cssText+'\n'}}catch(e){cssText+='/* Unable to read some CSS rules due to security restrictions */\n'}}return cssText}applyCodeChanges(){if(!this.adminMode||!this.currentEditingFile)return;const editor=document.getElementById('codeEditor');const newContent=editor.value;try{switch(this.currentEditingFile){case 'css':this.applyCSSChanges(newContent);break;case 'users':this.db.users=JSON.parse(newContent);this.saveDatabase();this.loadUserManagement();break;case 'timesheets':this.db.timesheets=JSON.parse(newContent);this.saveDatabase();this.loadAllContent();break}showToast('Changes applied successfully!','success');this.logAudit('admin_code_changed',{file:this.currentEditingFile})}catch(error){showToast('Error applying changes: '+error.message,'error')}}applyCSSChanges(cssText){const existingStyle=document.getElementById('adminCustomStyles');if(existingStyle){existingStyle.remove()}const style=document.createElement('style');style.id='adminCustomStyles';style.textContent=cssText;document.head.appendChild(style)}previewChanges(){showToast('Preview mode - Changes are temporary','info');this.applyCodeChanges()}exportSystemData(){if(!this.adminMode)return;const systemData={users:this.db.users,timesheets:this.db.timesheets,auditLog:this.db.auditLog,exportedAt:new Date().toISOString(),version:'1.0'};const blob=new Blob([JSON.stringify(systemData,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`MRE_System_Backup_${new Date().toISOString().split('T')[0]}.json`;a.click();URL.revokeObjectURL(url);showToast('System data exported!','success')}resetSystem(){if(!this.adminMode)return;if(!confirm('Are you sure you want to reset the entire system? This will delete ALL data!')){return}if(!confirm('This action cannot be undone. Type RESET to confirm.')){return}const confirmation=prompt('Type RESET to confirm system reset:');if(confirmation!=='RESET'){showToast('Reset cancelled','info');return}localStorage.clear();showToast('System reset complete. Reloading...','warning');setTimeout(()=>{location.reload()},2000)}viewAuditLogs(){if(!this.adminMode)return;const modalBody=`<div style="max-height:400px;overflow-y:auto;"><table class="timesheet-table"><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead><tbody>${this.db.auditLog.slice(-50).reverse().map(entry=>{const user=this.db.users.find(u=>u.id===entry.userId);return`<tr><td style="font-size:12px;">${new Date(entry.timestamp).toLocaleString()}</td><td>${user?.name||'System'}</td><td style="font-size:12px;">${entry.action}</td><td style="font-size:11px;">${JSON.stringify(entry.details).substring(0,50)}...</td></tr>`}).join('')}</tbody></table></div>`;showModal('System Audit Log (Last 50 entries)',modalBody)}}const timesheet=new SecureTimesheetSystem();function handleLogin(event){event.preventDefault();const email=document.getElementById('loginEmail').value;const password=document.getElementById('loginPassword').value;timesheet.login(email,password).then(success=>{if(!success){document.getElementById('loginPassword').value=''}})}function showTab(tabName){document.querySelectorAll('.tab-content').forEach(tab=>{tab.classList.remove('active')});document.querySelectorAll('.nav-tab').forEach(tab=>{tab.classList.remove('active')});document.getElementById(tabName).classList.add('active');event.target.classList.add('active');switch(tabName){case 'current-timesheets':timesheet.loadCurrentTimesheets();break;case 'my-vault':timesheet.loadMyVault();break;case 'my-archive':timesheet.loadMyArchive();break;case 'manager-vault':timesheet.loadManagerVault();break;case 'manager-archive':timesheet.loadManagerArchive();break;case 'admin-panel':timesheet.loadAdminPanel();break}}function showToast(message,type='info'){const toast=document.getElementById('toast');const msg=document.getElementById('toastMessage');msg.textContent=message;toast.className=`toast ${type}`;toast.style.display='block';setTimeout(()=>{toast.style.display='none'},4000)}function showModal(title,body,footer=''){document.getElementById('modalTitle').textContent=title;document.getElementById('modalBody').innerHTML=body;document.getElementById('modalFooter').innerHTML=footer;document.getElementById('modal').style.display='flex'}function closeModal(){document.getElementById('modal').style.display='none'}document.addEventListener('contextmenu',e=>e.preventDefault());document.addEventListener('selectstart',e=>{if(e.target.closest('.no-select')){e.preventDefault()}});document.addEventListener('keydown',function(e){if(e.key==='F12'||(e.ctrlKey&&e.shiftKey&&e.key==='I')||(e.ctrlKey&&e.shiftKey&&e.key==='C')||(e.ctrlKey&&e.key==='u')){e.preventDefault();return false}});
</script>
</body>
</html>
